<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>CB Systems ‚Ä¢ Painel do Gestor</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    :root{--bg:#f6f8fb;--ink:#0f172a;--muted:#64748b;--card:#fff;--primary:#0ea5e9;--ok:#22c55e;--warn:#f59e0b;--bad:#ef4444}
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--ink);font-family:'Segoe UI',system-ui,-apple-system,sans-serif}
    header{position:sticky;top:0;z-index:20;background:#0b1220;color:#fff;padding:16px 20px;font-weight:700;box-shadow:0 2px 10px rgba(0,0,0,.2)}
    .wrap{padding:18px}
    .login{display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:10px;background:var(--card);border-radius:14px;padding:12px 12px;box-shadow:0 1px 6px rgba(0,0,0,.08);margin-bottom:14px}
    select,button,input[type="month"]{padding:10px 12px;border:1px solid #e5e7eb;border-radius:10px;font-size:14px}
    button{background:var(--primary);color:#fff;border:none;cursor:pointer}
    button:hover{filter:brightness(.95)}
    .grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(300px,1fr));gap:14px}
    .card{background:var(--card);border-radius:14px;box-shadow:0 1px 6px rgba(0,0,0,.08);padding:14px}
    .title{font-weight:700;margin-bottom:6px;color:#0b1220}
    .muted{color:var(--muted);font-size:12px}
    .kpis{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:10px}
    .kpi{background:#fff;border-radius:12px;padding:12px;box-shadow:0 1px 4px rgba(0,0,0,.06)}
    .value{font-size:22px;font-weight:800}
    .pill{display:inline-flex;align-items:center;gap:6px;padding:6px 10px;border-radius:999px;font-size:12px}
    .pill.ok{background:#ecfdf5;color:#065f46}
    .pill.warn{background:#fffbeb;color:#92400e}
    .pill.bad{background:#fef2f2;color:#991b1b}
    ul{margin:0;padding-left:18px}
    li+li{margin-top:6px}
  </style>
</head>
<body>
<header>CB Systems ‚Ä¢ Painel do Gestor</header>
<div class="wrap">
  <div class="login">
    <label class="muted">Empresa
      <select id="empresa">
        <option value="">Selecione...</option>
        <option>MERCATTO DELICIA</option>
        <option>DELICIA GOURMET</option>
        <option>VILLA GOURMET</option>
        <option>M. KIDS</option>
        <option>PADARIA DELICIA</option>
      </select>
    </label>
    <label class="muted">Usu√°rio
      <select id="usuario"><option value="">Selecionar...</option></select>
    </label>
    <label class="muted">Per√≠odo
      <input id="periodo" type="month" />
    </label>
    <div style="display:flex;align-items:end"><button id="btnEntrar">Entrar</button></div>
  </div>

  <div class="grid" id="painel" style="display:none">
    <div class="card" style="grid-column:1/-1">
      <div class="title">Resumo</div>
      <div class="kpis">
        <div class="kpi"><div class="muted">Meta de Compras</div><div class="value" id="kpiMeta">--</div><div class="muted" id="kpiMetaHint">--</div></div>
        <div class="kpi"><div class="muted">Compras Realizadas</div><div class="value" id="kpiRealizado">--</div><div class="muted" id="kpiUtil">--</div></div>
        <div class="kpi"><div class="muted">Cancelamentos (R$)</div><div class="value" id="kpiCanc">--</div><div class="muted" id="kpiCancQtd">--</div></div>
        <div class="kpi"><div class="muted">Trava de Compras</div><div class="value" id="kpiTrava">--</div><div class="muted" id="kpiTravaHint">--</div></div>
        <div class="kpi"><div class="muted">Fornecedores (Total)</div><div class="value" id="kpiFornec">--</div><div class="muted" id="kpiSobra">--</div></div>
      </div>
    </div>

    <div class="card">
      <div class="title">Metas x Realizado</div>
      <canvas id="chartMeta"></canvas>
      <div id="metaPill" style="margin-top:8px"></div>
    </div>

    <div class="card">
      <div class="title">Cancelamentos (por motivo)</div>
      <canvas id="chartCancel"></canvas>
      <ul id="listaCancel" style="margin-top:8px"></ul>
    </div>

    <div class="card">
      <div class="title">Trava de Compras ‚Ä¢ Top Subcategorias (Fornecedores)</div>
      <canvas id="chartTravaCats"></canvas>
      <ul id="listaTravaCats" style="margin-top:8px"></ul>
    </div>

    <div class="card">
      <div class="title">Satisfa√ß√£o dos Clientes</div>
      <canvas id="chartSat"></canvas>
    </div>
  </div>
</div>

<script>
// ====== Config de usu√°rios (igual ao seu exemplo)
const usuariosPorEmpresa = {"MERCATTO DELICIA":["Lucas","Maria"],"DELICIA GOURMET":["Jo√£o","Patr√≠cia"],"VILLA GOURMET":["Carlos","Fernanda"],"M. KIDS":["Bruno"],"PADARIA DELICIA":["Ana","Roberto"]};
const senhaPorUsuario = {"Lucas":"1234","Maria":"5678","Jo√£o":"abcd","Patr√≠cia":"efgh","Carlos":"senha1","Fernanda":"senha2","Bruno":"kids123","Ana":"pao321","Roberto":"padaria"};

// ====== Endpoints (reais)
const URL_METAS  = 'https://script.google.com/macros/s/AKfycbziCPWWJxxfrnSeT3RHsNbw21z9MfnnB8JpV7ZQcZnvUQQ7dL3lVJdpUG7epACVjFaO/exec'; // TEXTO
const URL_CANCEL = 'https://script.google.com/macros/s/AKfycbzM1mmixFkFE5tbC-0Evc6GVyZEJkh88HCikNK08FujRwCrgUA1e_E29nMHip81kRPoSg/exec'; // TEXTO
const URL_SAT    = 'https://script.google.com/macros/s/AKfycbyK3A5CDn_EgA3pbRVToh87_qKWvbIry886OkR1AdkJi7RyvSgcwY0BmRqhbKQnEKwgrA/exec'; // JSON
const URL_TRAVAS = 'https://script.google.com/macros/s/AKfycbzkj-mfUUqwetIY5JKj0zPpTftzgVqCDFJLu45PlznBAGF4xm97EHnZQwqYUfhsS_1lFA/exec'; // JSON

let chMeta, chCancel, chSat, chTrava;

document.getElementById('empresa').addEventListener('change', e => {
  const emp = e.target.value; const users = usuariosPorEmpresa[emp]||[];
  const sel = document.getElementById('usuario'); 
  sel.innerHTML = '<option value="">Selecionar...</option>'+users.map(u=>`<option>${u}</option>`).join('');
});

document.getElementById('btnEntrar').addEventListener('click', filtrarPainel);

// Normaliza nome de empresa (tira acento e pontua√ß√£o)
function normEmpresa(s){
  return String(s||'')
    .normalize('NFD').replace(/\p{Diacritic}/gu,'')
    .replace(/[^A-Za-z0-9 ]/g,'')
    .replace(/\s+/g,' ')
    .trim()
    .toUpperCase();
}

async function filtrarPainel(){
  const empresa = document.getElementById('empresa').value;
  const usuario = document.getElementById('usuario').value;
  const periodo = document.getElementById('periodo').value; // YYYY-MM
  if(!empresa || !usuario){ alert('Preencha todos os campos.'); return; }
  const senha = prompt(`Digite a senha para ${usuario}`);
  if(senha !== senhaPorUsuario[usuario]){ alert('Senha incorreta.'); return; }

  const qs = periodo ? `?periodo=${encodeURIComponent(periodo)}` : '';

  // Carrega tudo em paralelo
  const [metasTxt, cancelTxt, satJson, travasJson] = await Promise.all([
    fetch(URL_METAS + qs).then(r=>r.text()).catch(()=>''),      // TEXTO
    fetch(URL_CANCEL + qs).then(r=>r.text()).catch(()=>''),     // TEXTO
    fetch(URL_SAT + qs).then(r=>r.json()).catch(()=>[]),        // JSON
    fetch(URL_TRAVAS + (qs + (qs? '&':'?') + 'empresa=' + encodeURIComponent(empresa))).then(r=>r.json()).catch(()=>[]) // JSON
  ]);

  // Normaliza√ß√µes
  const metas = parseMetasTexto(metasTxt);          // [{empresa, meta, realizado}]
  const canc = parseCancelamentosTexto(cancelTxt);  // [{empresa, itens:[{nome,valor}]}]
  const satAgg = aggregateSatisfacao(satJson);      // {EMPRESA_NORM: {Excelente,Bom,Regular,Ruim}}

  const alvo = normEmpresa(empresa);
  const metaEmp = metas.find(x=> normEmpresa(x.empresa)===alvo) || {};
  const cancEmp = (canc.find(x=> normEmpresa(x.empresa)===alvo) || {itens:[]}).itens;
  const trav = Array.isArray(travasJson) ? travasJson.find(t=> normEmpresa(t.empresa)===alvo) : null;

  // KPIs de metas
  const limite = num(metaEmp.meta);
  const realizado = num(metaEmp.realizado);
  setText('kpiMeta', moeda(limite));
  setText('kpiRealizado', moeda(realizado));
  const util = limite>0? (realizado/limite)*100 : 0;
  setText('kpiUtil', `${util.toFixed(1)}% do limite`);
  document.getElementById('metaPill').innerHTML = pill(util>100? 'üö® Estouro do limite':'‚úÖ Dentro do limite', util>100? 'bad': (util>=80?'warn':'ok'));

  // KPIs de cancelamentos
  const cancTotal = soma(cancEmp.map(i=>num(i.valor)));
  setText('kpiCanc', moeda(cancTotal));
  setText('kpiCancQtd', `${cancEmp.length} itens`);

  // KPIs de TRAVAS
  if(trav){
    setText('kpiTrava', moeda(trav.travaCompras));
    const fornecAbs = Math.abs(trav.fornecedoresTotal||0);
    setText('kpiFornec', moeda(fornecAbs));
    const sobra = trav.sobra ?? (trav.travaCompras - fornecAbs);
    setText('kpiSobra', (sobra>=0? 'Sobra: ':'Estouro: ')+moeda(Math.abs(sobra)));
    const consumo = trav.consumoPct ?? (trav.travaCompras>0? (fornecAbs/trav.travaCompras)*100:0);
    document.getElementById('kpiTravaHint').textContent = `${consumo.toFixed(1)}% consumidos`;

    // Top subcategorias de fornecedores
    const catFor = (trav.categorias||[]).find(c=> normEmpresa(c.nome).includes('FORNECEDOR'));
    const subs = catFor? (catFor.subs||[]) : [];
    const top = [...subs].sort((a,b)=>Math.abs(b.valor)-Math.abs(a.valor)).slice(0,10);
    drawBar('chartTravaCats', top.map(x=>x.nome), top.map(x=>Math.abs(x.valor)), 'R$');
    const ul = document.getElementById('listaTravaCats'); ul.innerHTML='';
    top.forEach(s=>{ const li=document.createElement('li'); li.textContent = `${s.nome} ‚Äî ${moeda(s.valor)}${s.pctDaTrava? ' ‚Ä¢ '+s.pctDaTrava.toFixed(1)+'% da TRAVA':''}`; ul.appendChild(li); });
  } else {
    drawBar('chartTravaCats', [], [], 'R$');
    document.getElementById('listaTravaCats').innerHTML = '<li>Sem dados de TRAVAS</li>';
  }

  // Gr√°ficos
  drawBar('chartMeta', ['Meta','Realizado'], [limite,realizado], 'R$');

  const motMap = {}; (cancEmp||[]).forEach(i=>{
    const k=i.motivo||'Sem motivo'; motMap[k]=(motMap[k]||0)+num(i.valor);
  });
  drawBar('chartCancel', Object.keys(motMap), Object.values(motMap), 'R$');

  const sat = satAgg[alvo] || {Excelente:0,Bom:0,Regular:0,Ruim:0};
  drawPie('chartSat', ['Excelente','Bom','Regular','Ruim'], [sat.Excelente,sat.Bom,sat.Regular,sat.Ruim]);

  // Lista top 5 cancelamentos
  const list = document.getElementById('listaCancel'); list.innerHTML='';
  [...cancEmp].sort((a,b)=>num(b.valor)-num(a.valor)).slice(0,5).forEach(it=>{
    const li=document.createElement('li');
    li.textContent = `${it.nome||'Item'} ‚Äî ${moeda(it.valor)}${it.motivo? ' ‚Ä¢ '+it.motivo:''}`;
    list.appendChild(li);
  });

  document.getElementById('painel').style.display='grid';
}

// ===== Parsers de TEXTO
function parseMetasTexto(text){
  const linhas = text.split(/\r?\n/).map(l=>l.trim()).filter(Boolean);
  const out=[]; let emp=null;
  for(let i=0;i<linhas.length;i++){
    const l=linhas[i];
    if(/^[A-Z√Å√É√Ç√â√ä√ç√ì√î√ï√ö√á\.\s\-]+$/.test(l) && !l.includes('AN√ÅLISE') && !l.toUpperCase().includes('ATUALIZADO'))
      emp=l.replace(/[*‚Ä¢]/g,'').trim();
    const mMeta=l.match(/Meta:\s*R\$\s*([0-9\._.,]+)/i);
    if(mMeta){
      const metaVal=num(mMeta[1]); let real=0;
      for(let j=i+1;j<i+5 && j<linhas.length;j++){
        const mr=linhas[j].match(/Realizado:\s*R\$\s*([0-9\._.,]+)/i);
        if(mr){ real=num(mr[1]); break; }
      }
      if(emp) out.push({ empresa: emp, meta: metaVal, realizado: real });
    }
  }
  return out;
}

function parseCancelamentosTexto(text){
  const linhas = text.split(/\r?\n/);
  const out=[]; let empresa=null; let itens=[];
  function pushEmpresa(){ if(empresa){ out.push({empresa, itens:[...itens]}); } }
  for(const raw of linhas){
    const l = raw.trim();
    const cab = l.match(/^\*\s*([^*\-‚Äì]+?)\s*[\-‚Äì]\s*R\$\s*([0-9\._.,]+)/);
    if(cab){ pushEmpresa(); empresa=cab[1].trim(); itens=[]; continue; }
    const it = l.match(/^(?:[\p{Emoji}\p{So}\p{Sk}\p{Sc}\p{P}]{1,3})?\s*([^\-‚Äì]+?)\s*[\-‚Äì]\s*R\$\s*([0-9\._.,]+)/u);
    if(it && empresa){ itens.push({ nome: it[1].trim(), valor: num(it[2]) }); }
  }
  pushEmpresa();
  return out;
}

// ===== Satisfa√ß√£o ‚Üí buckets por empresa
function aggregateSatisfacao(arr){
  const map={};
  const norm=(w)=>{const s=String(w||'').toLowerCase();
    if(s.startsWith('√≥tim')||s.startsWith('otim'))return 'Excelente';
    if(s.startsWith('bom'))return 'Bom';
    if(s.startsWith('regular'))return 'Regular';
    if(s.startsWith('ruim'))return 'Ruim';
    return null;
  };
  const fields=['ambiente','atendimento','comida','musica','climatizacao','bebidas','iluminacao'];
  arr.forEach(r=>{
    const empNorm=normEmpresa(r.empresa||r.Empresa||'');
    if(!map[empNorm]) map[empNorm]={Excelente:0,Bom:0,Regular:0,Ruim:0};
    fields.forEach(f=>{const b=norm(r[f]); if(b) map[empNorm][b]++;});
  });
  return map;
}

// ===== Helpers UI
function drawBar(id, labels, data, label){
  const ctx=document.getElementById(id).getContext('2d');
  if(ctx._chart) ctx._chart.destroy();
  ctx._chart = new Chart(ctx,{type:'bar',
    data:{labels,datasets:[{label,data}]},
    options:{responsive:true,plugins:{legend:{display:false}},scales:{y:{beginAtZero:true}}}
  });
}
function drawPie(id, labels, data){
  const ctx=document.getElementById(id).getContext('2d');
  if(ctx._chart) ctx._chart.destroy();
  ctx._chart = new Chart(ctx,{type:'pie',
    data:{labels,datasets:[{data,backgroundColor:['#22c55e','#0ea5e9','#f59e0b','#ef4444']}]},
    options:{responsive:true,plugins:{legend:{position:'bottom'}}}
  });
}
function setText(id, t){ const el=document.getElementById(id); if(el) el.textContent=t; }
function soma(a){ return a.reduce((x,y)=>x+(+y||0),0); }
function num(v){ const s=String(v||'').replace(/[^0-9,.-]/g,'').replace(/\.(?=\d{3})/g,'').replace(',','.'); const n=parseFloat(s); return isNaN(n)?0:n; }
function moeda(v){ return Number(v||0).toLocaleString('pt-BR',{style:'currency',currency:'BRL'}); }
function pill(txt,kind){ return `<span class="pill ${kind}">${txt}</span>`; }
</script>
</body>
</html>
