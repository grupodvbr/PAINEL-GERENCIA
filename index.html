<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8" />
<title>CB Systems • Painel de Travas</title>
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
<style>
  :root{
    --bg:#f6f8fb; --ink:#0f172a; --muted:#64748b; --card:#fff; --primary:#0ea5e9; --shadow:0 1px 8px rgba(0,0,0,.06);
    --red:#b91c1c; --green:#065f46; --amber:#92400e; --redbg:#fef2f2; --greenbg:#ecfdf5; --amberbg:#fffbeb;
  }
  *{box-sizing:border-box}
  body{background:var(--bg);color:var(--ink);font-family:'Segoe UI',system-ui,-apple-system,sans-serif;margin:0}
  header{position:sticky;top:0;z-index:10;background:#0b1220;color:#fff;padding:14px 18px;font-weight:700;box-shadow:0 2px 12px rgba(0,0,0,.25)}
  .wrap{padding:16px;max-width:1200px;margin:0 auto}
  .filters{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:10px;background:var(--card);border-radius:14px;padding:12px;box-shadow:var(--shadow)}
  select,input[type="month"]{width:100%;padding:10px 12px;border:1px solid #e5e7eb;border-radius:10px;font-size:14px;background:#fff}
  .section{margin-top:14px}
  .company>.title{font-weight:800;margin:10px 2px 12px}

  /* 1 card por linha no mobile; 2 em telas >=680px */
  .kpis{display:grid;grid-template-columns:1fr;gap:10px}
  @media(min-width:680px){.kpis{grid-template-columns:repeat(2,minmax(0,1fr))}}
  .kpi{background:var(--card);border-radius:14px;padding:10px;box-shadow:var(--shadow);position:relative}
  .kpi .label{color:var(--muted);font-size:11px;margin-bottom:4px}
  .kpi .value{font-size:18px;font-weight:900}
  .kpi .hint{color:var(--muted);font-size:11px;margin-top:2px}
  .kpi.bad{background:var(--redbg);color:var(--red)}
  .kpi.good{background:var(--greenbg);color:var(--green)}
  .kpi.warn{background:var(--amberbg);color:var(--amber)}
  .progress{height:6px;background:#e5e7eb;border-radius:999px;margin-top:8px;overflow:hidden}
  .progress>span{display:block;height:100%;background:var(--primary);width:0;border-radius:999px;transition:width .2s}
  .note{color:#6b7280;font-size:12px;margin-top:6px}

  .btn-link{position:absolute;top:6px;right:8px;font-size:11px;border:1px solid #bae6fd;background:#e0f2fe;color:#0369a1;padding:4px 8px;border-radius:999px;cursor:pointer}
  .btn-link:hover{filter:brightness(.97)}

  .grid{display:grid;grid-template-columns:1fr;gap:12px;margin-top:12px}
  .card{background:var(--card);border-radius:14px;padding:12px;box-shadow:var(--shadow)}
  .card .title{font-weight:700;margin-bottom:8px}
  .list{margin:0;padding-left:18px}
  .list li+li{margin-top:6px}

  .chart-toolbar{display:flex;flex-wrap:wrap;gap:8px;margin-bottom:10px;align-items:center}
  .chip{display:inline-flex;align-items:center;gap:6px;border:1px solid #e5e7eb;border-radius:999px;padding:6px 10px;background:#fff}
  .chip select,.chip input{border:none;background:transparent;outline:none;font-size:13px}
  .chip button{border:none;background:#0ea5e9;color:#fff;border-radius:999px;padding:6px 10px;cursor:pointer}
  .chart-note{margin:6px 0 0 4px;color:#6b7280;font-size:13px}

  /* Modal */
  #modal{display:none;position:fixed;inset:0;z-index:1000;align-items:center;justify-content:center}
  #modal .backdrop{position:absolute;inset:0;background:rgba(0,0,0,.45)}
  #modal .panel{position:relative;z-index:1;width:min(94vw,680px);max-height:80vh;overflow:auto;background:#fff;border-radius:12px;box-shadow:0 10px 30px rgba(0,0,0,.25);padding:12px;will-change:transform}
  #modal header{position:sticky;top:0;background:#fff;margin:-12px -12px 8px;padding:10px 12px;border-radius:12px 12px 0 0;box-shadow:0 1px 0 rgba(0,0,0,.06)}
  #modal h3{margin:0;font-size:16px}
  #modal .close{appearance:none;border:none;background:transparent;font-size:22px;line-height:1;cursor:pointer;color:#334155}
  #modal .list{list-style:none;margin:0;padding:0}
  #modal .item{display:flex;align-items:center;gap:12px;padding:10px;border-bottom:1px dashed #e5e7eb}
  #modal .item b{flex:1 1 auto;min-width:0}
  #modal .item .val{flex:0 0 140px;text-align:right;white-space:nowrap}
  .empty{color:#6b7280;font-size:13px;padding:8px}
</style>
</head>
<body>
<header>CB Systems • Painel de Travas</header>

<div class="wrap">
  <div class="filters">
    <label>Empresa
      <select id="empresa">
        <option>TODAS AS EMPRESAS</option>
        <option>MERCATTO DELICIA</option>
        <option>DELICIA GOURMET</option>
        <option>VILLA GOURMET</option>
        <option>M. KIDS</option>
        <option>PADARIA DELICIA</option>
      </select>
    </label>
    <label>Período
      <input id="periodo" type="month" />
    </label>
  </div>

  <div id="content" class="section"></div>
</div>

<!-- Modal -->
<div id="modal" aria-hidden="true">
  <div class="backdrop" data-close></div>
  <div class="panel" role="dialog" aria-modal="true" aria-labelledby="modal-title">
    <header style="display:flex;align-items:center;justify-content:space-between">
      <h3 id="modal-title">Detalhamento</h3>
      <button class="close" title="Fechar" aria-label="Fechar" data-close>&times;</button>
    </header>
    <ul id="modal-list" class="list"></ul>
    <div id="modal-empty" class="empty" style="display:none">Sem itens para exibir.</div>
  </div>
</div>

<script>
/* ======= CONFIG ======= */
const API_BASE='https://script.google.com/macros/s/AKfycbyx8QRuJF5Q6Ib6zZwkQGYM8DWx2WPYU7T_tuaLf6ks_0KdRU1FlFu_G_GZ2aHMCDOuag/exec';
const EMPRESAS=['MERCATTO DELICIA','DELICIA GOURMET','VILLA GOURMET','M. KIDS','PADARIA DELICIA'];

/* Planos de contas que entram no “já comprado” + listas */
const PLANOS_WHITELIST = [
  'Fornecedores em geral (insumos)','Bebidas (adegas)','Cerveja/Long','Refrigerantes/água/suco',
  'Frios/congelados','Doces e chocolates','Laticínios','Gelatto','Hortaliças (Padaria)','Hortifruti',
  'Processados/assados (Panificação)','Salmão','Pescados (peixaria)','Chopp Brahma','Açougues',
  'Aves','Mercados Locais LEM','Mercado (Materiais Não Consumo)'
];

/* ======= HELPERS ======= */
const norm=s=>String(s||'').normalize('NFD').replace(/\p{Diacritic}/gu,'').replace(/[^A-Za-z0-9 ]/g,'').replace(/\s+/g,' ').trim().toUpperCase();
const moeda=v=>Number(v||0).toLocaleString('pt-BR',{style:'currency',currency:'BRL'});
const aliases=(o,keys,def=0)=>{for(const k of keys){const v=o?.[k];if(v!==undefined&&v!==''&&!isNaN(Number(v)))return Number(v);}return def;};

/* Cache (5 min) */
const TTL=5*60*1000, CK=(e,p)=>`travas:${e}|${p}`;
const getC=(e,p)=>{try{const r=sessionStorage.getItem(CK(e,p));if(!r)return null;const o=JSON.parse(r);return (Date.now()-o.t<TTL)?o.v:null}catch{return null}};
const setC=(e,p,v)=>{try{sessionStorage.setItem(CK(e,p),JSON.stringify({t:Date.now(),v}))}catch{}};

/* Datas / previsão */
function parseYYYYMM(s){if(!s)return null;const [y,m]=s.split('-').map(Number);if(!y||!m)return null;return new Date(y,m-1,1)}
function daysInMonth(d){return new Date(d.getFullYear(),d.getMonth()+1,0).getDate()}
function monthCompare(a,b){if(a.getFullYear()===b.getFullYear()&&a.getMonth()===b.getMonth())return 0;return (a<b)?-1:1}
function progressCalc(limit, spent, perStr){
  const today=new Date(), pd=parseYYYYMM(perStr)||new Date(today.getFullYear(),today.getMonth(),1);
  const dim=daysInMonth(pd), cmp=monthCompare(pd,new Date(today.getFullYear(),today.getMonth(),1));
  let elapsed=0, remain=0;
  if(cmp<0){elapsed=dim;remain=0;} else if(cmp>0){elapsed=0;remain=dim;} else {elapsed=Math.min(today.getDate(),dim);remain=Math.max(dim-elapsed,0);}
  const pct=limit>0?spent/limit*100:0, available=limit-spent;
  const daily=elapsed>0?spent/elapsed:0, forecast=spent+daily*remain, forecastPct=limit>0?forecast/limit*100:0;
  let status='neutral'; if(cmp<0) status=spent>limit?'bad':'good'; else if(cmp===0) status=forecast>limit?'bad':(pct>=80?'warn':'good'); else status=pct>=80?'warn':'neutral';
  return {pct,available,forecast,forecastPct,status};
}

/* Lê total geral de “fonte 9” (fallback geral) */
function fonte9Total(rec){
  const keys=['totalFonte9','fonte9Total','valorCompradoFonte9','compradoFonte9','valorTotalComprado'];
  for(const k of keys){const v=rec?.[k]; if(v!==undefined&&v!==''&&!isNaN(Number(v))) return Number(v);}
  if(Array.isArray(rec?.fonte9Detalhe)) return rec.fonte9Detalhe.reduce((a,i)=>a+Math.abs(Number(i.valor??i.total??0)),0);
  if(Array.isArray(rec?.categorias)){
    let t=0; rec.categorias.forEach(c=>(c.subs||[]).forEach(s=>{const f=Number(s.font); if(f===9||s.isSub===true||s.font==null) t+=Math.abs(Number(s.valor||0))})); return t;
  }
  return 0;
}

/* Extrai lista de planos (nome/valor) */
function extractPlanos(rec){
  if (Array.isArray(rec?.planosFonte9) && rec.planosFonte9.length) {
    return rec.planosFonte9.map(p=>({nome:String(p.nome??'—'),valor:Math.abs(Number(p.valor??0))}));
  }
  const PLAN_NAME_COLS=[1,6,11,16,21]; // B,G,L,Q,V (grid/tabela)
  const planosFromGrid = (grid=>{
    if(!Array.isArray(grid)||!Array.isArray(grid[0])) return [];
    const map=new Map();
    grid.forEach(row=>{
      PLAN_NAME_COLS.forEach(idx=>{
        const nome=row[idx]; const val=row[idx+1];
        if(nome!=null && nome!=='' && val!=null && val!==''){
          const v=Number(String(val).toString().replace(/[^\d\-.,]/g,'').replace(/\.(?=\d{3})/g,'').replace(',','.'));
          if(!isNaN(v)) map.set(String(nome),(map.get(String(nome))||0)+Math.abs(v));
        }
      });
    });
    return Array.from(map, ([nome,valor])=>({nome,valor}));
  })(rec?.grid || rec?.tabela);
  if (planosFromGrid.length) return planosFromGrid;

  if (Array.isArray(rec?.fonte9Detalhe) && rec.fonte9Detalhe.length) {
    return rec.fonte9Detalhe.map(i=>({nome:i.nome??i.planocontas??i.categoria??'—',valor:Math.abs(Number(i.valor??i.total??0))}));
  }
  if (Array.isArray(rec?.categorias)){
    const out=[]; rec.categorias.forEach(c=>(c.subs||[]).forEach(s=>{const f=Number(s.font); if(f===9||s.isSub===true||s.font==null) out.push({nome:s.nome??'—',valor:Math.abs(Number(s.valor||0))})}));
    if(out.length) return out;
  }
  if (Array.isArray(rec?.fornecedoresDetalhe) && rec.fornecedoresDetalhe.length) {
    return rec.fornecedoresDetalhe.map(i=>({nome:i.nome??'—',valor:Math.abs(Number(i.valor||0))}));
  }
  return [];
}

/* Filtra pelos planos da sua lista */
const WL = PLANOS_WHITELIST.map(norm);
function filtrarPlanos(planos){
  return (planos||[]).filter(p=>WL.includes(norm(p.nome)));
}

/* API */
async function getEmpresaPeriodo(emp, periodo){
  const c=getC(emp,periodo); if(c) return c;
  const url=`${API_BASE}?empresa=${encodeURIComponent(emp)}${periodo?`&periodo=${encodeURIComponent(periodo)}`:''}`;
  const r=await fetch(url,{cache:'no-store'}); const t=await r.text(); if(!r.ok) throw new Error(t);
  let j; try{j=JSON.parse(t);}catch{throw new Error('JSON inválido');}
  let rec=j;
  if(j?.empresa) rec=j;
  else if(Array.isArray(j?.data)) rec=j.data.find(x=>norm(x.empresa||x.Empresa)===norm(emp))||j.data[0];
  else if(Array.isArray(j)) rec=j.find(x=>norm(x.empresa||x.Empresa)===norm(emp))||j[0];
  setC(emp,periodo,rec); return rec;
}

/* UI + corrida para evitar “flicker” */
const selEmpresa=document.getElementById('empresa');
const inpPeriodo=document.getElementById('periodo');
const container=document.getElementById('content');
let ChartLib=null;
let currentRun = 0;

/* Modal */
function closeModal(){const m=document.getElementById('modal');m.style.display='none';m.setAttribute('aria-hidden','true');}
function openModal(title, items){
  const modal=document.getElementById('modal');
  document.getElementById('modal-title').textContent=title||'Detalhes';
  const ul=document.getElementById('modal-list');
  const empty=document.getElementById('modal-empty');
  ul.innerHTML='';

  const arr=(items||[]).slice().sort((a,b)=>Math.abs(b.valor)-Math.abs(a.valor));
  if(arr.length){
    empty.style.display='none';
    arr.forEach(d=>{
      const li=document.createElement('li'); li.className='item';
      const b=document.createElement('b'); b.textContent=d.nome||'—';
      const v=document.createElement('span'); v.className='val';
      if(d.fmt==='pct'){ v.textContent = `${(Number(d.valor)||0).toFixed(1)}%`; }
      else{ v.textContent = moeda(Math.abs(Number(d.valor||0))); }
      li.appendChild(b); li.appendChild(v); ul.appendChild(li);
    });
  }else{
    empty.style.display='block';
  }
  modal.style.display='flex'; modal.setAttribute('aria-hidden','false');
}
document.addEventListener('click',(e)=>{ if(e.target.matches('[data-close], #modal .backdrop')) closeModal(); });
document.addEventListener('keydown',(e)=>{ if(e.key==='Escape') closeModal(); });

selEmpresa.addEventListener('change', run);
inpPeriodo.addEventListener('change', run);

window.addEventListener('DOMContentLoaded', ()=>{
  const hoje=new Date();
  inpPeriodo.value=hoje.toISOString().slice(0,7); // mês atual por padrão
  run();
});

/* Render principal */
async function run(){
  const runId = ++currentRun;
  const empSel=selEmpresa.value, periodo=inpPeriodo.value;
  container.innerHTML='';

  const empresas = empSel==='TODAS AS EMPRESAS' ? EMPRESAS : [empSel];

  for(const emp of empresas){
    try{
      const rec=await getEmpresaPeriodo(emp, periodo);
      if (runId !== currentRun) return;

      const periodOk = rec?.matchesPeriod !== false;

      const travaTotal= periodOk ? aliases(rec,['travaTotal','trava_total','E2','travaTotalE2'],0) : 0;
      const fornecLim = periodOk ? aliases(rec,['travaCompras','trava_compras','fornecedoresTotal','D2'],0) : 0;

      // ► Planos filtrados (apenas whitelist)
      const planosAll  = periodOk ? extractPlanos(rec) : [];
      const planosFilt = filtrarPlanos(planosAll);

      // ► Já comprado de Fornecedores = SOMA dos planos da lista
      const fornComp = planosFilt.reduce((a,p)=>a+Math.abs(Number(p.valor||0)),0);

      // Gasto geral p/ Trava Total (mantemos total fonte 9 como antes)
      const fonte9    = periodOk ? fonte9Total(rec) : 0;

      const gTotal=progressCalc(travaTotal, fonte9, periodo);
      const gForn =progressCalc(fornecLim,  fornComp, periodo);

      const sec=document.createElement('section'); sec.className='company';
      sec.innerHTML = `
        <div class="title">${emp}</div>
        <div class="kpis">
          <div class="kpi">
            <div class="label">🔒 Trava Total (E2)</div>
            <div class="value">${moeda(travaTotal)}</div>
            <div class="hint">
              Gasto: <b>${moeda(fonte9)}</b> • ${gTotal.pct.toFixed(1)}%<br/>
              Disponível: <b>${moeda(gTotal.available)}</b>
            </div>
            <div class="progress"><span style="width:${Math.min(gTotal.pct,100)}%"></span></div>
            ${!periodOk?`<div class="note">Sem dados para ${periodo}. Última data: ${rec?.dataRef||'—'}.</div>`:''}
          </div>

          <div class="kpi ${gForn.status==='bad'?'bad':gForn.status==='warn'?'warn':(gForn.status==='good'?'good':'')}">
            <button class="btn-link" data-ver-planos>Ver planos</button>
            <div class="label">🚧 Fornecedores Total (D2)</div>
            <div class="value">${moeda(fornecLim)}</div>
            <div class="hint">
              Já comprado: <b>${moeda(fornComp)}</b> • ${gForn.pct.toFixed(1)}%<br/>
              Disponível: <b>${moeda(gForn.available)}</b><br/>
              Previsão fim do mês: <b>${moeda(gForn.forecast)}</b> (${gForn.forecastPct.toFixed(1)}%)
            </div>
            <div class="progress"><span style="width:${Math.min(gForn.pct,100)}%"></span></div>
            ${!periodOk?`<div class="note">Sem dados para ${periodo}. Última data: ${rec?.dataRef||'—'}.</div>`:''}
          </div>
        </div>
      `;
      container.appendChild(sec);
      // Ver planos -> lista apenas whitelist
      sec.querySelector('[data-ver-planos]').addEventListener('click',()=>{
        openModal(`Planos de Contas — ${emp}`, planosFilt);
      });

      // gráfico apenas quando 1 empresa selecionada
      if(empSel!=='TODAS AS EMPRESAS'){
        const chartWrap=document.createElement('div'); chartWrap.className='grid';
        chartWrap.innerHTML=renderChartBlock(emp);
        container.appendChild(chartWrap);
        await mountChart(emp, chartWrap, runId);
      }
    }catch(err){
      if (runId !== currentRun) return;
      container.insertAdjacentHTML('beforeend', `<section class="company"><div class="title">${emp}</div><div class="kpi bad"><div class="label">Erro</div><div class="value" style="font-size:16px">${String(err.message||err)}</div></div></section>`);
    }
  }
}

/* Bloco do gráfico — padrão: janeiro → mês atual. Gráfico vazio até escolher um plano */
function renderChartBlock(emp){
  const now=new Date(); const year=now.getFullYear();
  const from=`${year}-01`;
  const to=`${year}-${String(now.getMonth()+1).padStart(2,'0')}`;
  const planId=`plan-${Math.random().toString(36).slice(2,7)}`, fromId=`from-${Math.random().toString(36).slice(2,7)}`, toId=`to-${Math.random().toString(36).slice(2,7)}`, cvs=`cv-${Math.random().toString(36).slice(2,7)}`;
  return `
    <div class="card">
      <div class="title">Evolução de compras (por Plano de Contas)</div>
      <div class="chart-toolbar">
        <span class="chip">Plano de contas:
          <select id="${planId}">
            <option value="" selected disabled>Selecione…</option>
          </select>
        </span>
        <span class="chip">De: <input id="${fromId}" type="month" value="${from}"></span>
        <span class="chip">Até: <input id="${toId}" type="month" value="${to}"></span>
        <span class="chip"><button id="${cvs}-apply">Aplicar</button></span>
      </div>
      <canvas id="${cvs}" height="180"></canvas>
      <div class="chart-note" id="${cvs}-note">Escolha um plano acima para ver o gráfico.</div>
      <div class="title" style="margin-top:12px">Despesas mais caras (Top 10 do mês mais recente)</div>
      <ul class="list" id="${cvs}-top"></ul>
    </div>`;
}

/* Range de meses */
function monthRange(from,to){let a=parseYYYYMM(from),b=parseYYYYMM(to);if(!a||!b)return[];if(a>b){const t=a;a=b;b=t;}const out=[],c=new Date(a);while(c<=b){out.push(`${c.getFullYear()}-${String(c.getMonth()+1).padStart(2,'0')}`);c.setMonth(c.getMonth()+1);}return out}

/* Séries (valor do ÚLTIMO dia do mês; usa apenas whitelist) */
async function buildSeries(emp, from, to){
  const months=monthRange(from,to), labels=[...months];
  const planMap={};                 // {plano:[v1,v2,...]}
  const plansSet=new Set();
  const totalsByMonth=new Array(months.length).fill(0);

  for(let i=0;i<months.length;i++){
    const per=months[i];
    const rec=await getEmpresaPeriodo(emp, per);
    const periodOk = rec?.matchesPeriod !== false;
    const planos= periodOk ? filtrarPlanos(extractPlanos(rec)) : [];
    planos.forEach(p=>{
      const nome=String(p.nome);
      const val=Math.abs(Number(p.valor||0));
      plansSet.add(nome);
      if(!planMap[nome]) planMap[nome]=new Array(months.length).fill(0);
      planMap[nome][i]=val;
      totalsByMonth[i]+=val;
    });
  }
  const totalsOverall=totalsByMonth.reduce((a,b)=>a+b,0);
  return {labels,planMap,plans:[...plansSet].sort(),totalsByMonth,totalsOverall};
}

/* Chart */
async function mountChart(emp, holder, runIdAtMount){
  if(!ChartLib){
    await new Promise((ok,ko)=>{const s=document.createElement('script');s.src='https://cdn.jsdelivr.net/npm/chart.js';s.onload=ok;s.onerror=ko;document.head.appendChild(s);});
    ChartLib=window.Chart;
  }
  const planSel=holder.querySelector('select');
  const fromInp=holder.querySelector('input[id^="from-"]');
  const toInp=holder.querySelector('input[id^="to-"]');
  const cvs=holder.querySelector('canvas');
  const btn=holder.querySelector('button[id$="-apply"]');
  const topList=holder.querySelector('ul');
  const note=holder.querySelector('.chart-note');

  let cachedSeries=null;

  async function populatePlans(){
    topList.innerHTML='<li>Carregando…</li>';
    cachedSeries = await buildSeries(emp, fromInp.value, toInp.value);
    if (runIdAtMount !== currentRun) return;
    planSel.innerHTML='<option value="" selected disabled>Selecione…</option>' + cachedSeries.plans.map(p=>`<option value="${p}">${p}</option>`).join('');
    // Top 10 (mês mais recente)
    const last=cachedSeries.labels.length-1;
    const arr=Object.entries(cachedSeries.planMap).map(([nome,vals])=>({nome,valor:Math.abs(vals[last]||0)})).sort((a,b)=>b.valor-a.valor).slice(0,10);
    topList.innerHTML=arr.map(i=>`<li data-plan="${i.nome}" style="cursor:pointer">${i.nome} — <b>${moeda(i.valor)}</b></li>`).join('') || '<li>Nada a mostrar.</li>';

    // clique item Top10 → participação no período
    topList.onclick=(ev)=>{
      const li=ev.target.closest('li[data-plan]'); if(!li) return;
      const plan=li.getAttribute('data-plan');
      showShare(plan);
    };
  }

  function showShare(plan){
    const vals=cachedSeries.planMap[plan]||[];
    const sumPlan=vals.reduce((a,b)=>a+Math.abs(b||0),0);
    const sumTot=cachedSeries.totalsByMonth.reduce((a,b)=>a+Math.abs(b||0),0);
    const pct=sumTot>0?(sumPlan/sumTot*100):0;
    openModal(`Participação — ${plan}`,[{nome:'Valor no período',valor:sumPlan},{nome:'Total do período',valor:sumTot},{nome:'Participação',fmt:'pct',valor:pct}]);
  }

  async function draw(){
    if(holder.__chart) holder.__chart.destroy();
    if(!cachedSeries){ await populatePlans(); }
    const chosen=planSel.value||'';
    if(!chosen){
      note.textContent='Escolha um plano acima para ver o gráfico.';
      return;
    }
    note.textContent='';
    const ds=[{label:chosen,data:cachedSeries.planMap[chosen]||new Array(cachedSeries.labels.length).fill(0),tension:.25}];
    holder.__chart=new ChartLib(cvs.getContext('2d'),{
      type:'line',
      data:{labels:cachedSeries.labels,datasets:ds},
      options:{
        responsive:true,
        plugins:{
          legend:{position:'bottom'},
          tooltip:{ callbacks:{ label:(ctx)=>`${ctx.dataset.label}: ${moeda(ctx.parsed.y)}` } }
        },
        scales:{y:{beginAtZero:true}}
      }
    });
  }

  btn.addEventListener('click', async()=>{ cachedSeries=null; await populatePlans(); await draw(); });
  planSel.addEventListener('change', draw);

  await populatePlans(); // carrega planos e Top10; gráfico fica vazio até escolher
}
</script>
</body>
</html>
