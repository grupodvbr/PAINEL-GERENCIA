<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8" />
<title>CB Systems • Painel de Travas</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
  :root{--bg:#f6f8fb;--ink:#0f172a;--muted:#64748b;--card:#fff;--primary:#0ea5e9;--shadow:0 1px 8px rgba(0,0,0,.06)}
  *{box-sizing:border-box}
  body{background:var(--bg);color:var(--ink);font-family:'Segoe UI',system-ui,-apple-system,sans-serif;margin:0}
  header{position:sticky;top:0;z-index:10;background:#0b1220;color:#fff;padding:14px 18px;font-weight:700;box-shadow:0 2px 12px rgba(0,0,0,.25)}
  .wrap{padding:18px;max-width:1200px;margin:0 auto}
  .filters{display:grid;grid-template-columns:repeat(auto-fit,minmax(240px,1fr));gap:10px;background:var(--card);border-radius:14px;padding:12px;box-shadow:var(--shadow)}
  select,input[type="month"]{padding:10px 12px;border:1px solid #e5e7eb;border-radius:10px;font-size:14px}
  .section{margin-top:16px}
  .company>.title{font-weight:800;margin:10px 2px 8px}
  .kpis{display:grid;grid-template-columns:repeat(auto-fit,minmax(280px,1fr));gap:12px}
  .kpi{background:var(--card);border-radius:14px;padding:14px;box-shadow:var(--shadow)}
  .kpi.red{background:#fef2f2;color:#991b1b}
  .kpi .label{color:var(--muted);font-size:12px;margin-bottom:6px}
  .kpi .value{font-size:24px;font-weight:900}
  .kpi .hint{color:var(--muted);font-size:12px}
  .grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(320px,1fr));gap:14px;margin-top:12px}
  .card{background:var(--card);border-radius:14px;padding:14px;box-shadow:var(--shadow)}
  .card .title{font-weight:700;margin-bottom:8px}
  /* Modal */
  #modal{display:none;position:fixed;inset:0;background:rgba(0,0,0,.6);align-items:center;justify-content:center;z-index:1000}
  #modal .box{background:#fff;padding:18px;border-radius:12px;max-width:560px;width:92%;max-height:80%;overflow:auto;box-shadow:0 10px 30px rgba(0,0,0,.25)}
  #modal .box h3{margin:0 0 8px}
  #modal .box ul{margin:10px 0 0;padding-left:18px}
  #modal .box button{margin-top:12px;background:#0ea5e9;color:#fff;border:none;border-radius:10px;padding:8px 12px;cursor:pointer}
</style>
</head>
<body>
<header>CB Systems • Painel de Travas</header>

<div class="wrap">
  <div class="filters">
    <label>Empresa
      <select id="empresa">
        <option>TODAS AS EMPRESAS</option>
        <option>MERCATTO DELICIA</option>
        <option>DELICIA GOURMET</option>
        <option>VILLA GOURMET</option>
        <option>M. KIDS</option>
        <option>PADARIA DELICIA</option>
      </select>
    </label>
    <label>Período
      <input id="periodo" type="month" />
    </label>
  </div>
  <div id="content" class="section"></div>
</div>

<!-- Modal -->
<div id="modal">
  <div class="box">
    <h3 id="modal-title">Detalhamento Fornecedores</h3>
    <ul id="modal-list"></ul>
    <button onclick="document.getElementById('modal').style.display='none'">Fechar</button>
  </div>
</div>

<script>
/* ======= ENDPOINT (TRAVAS) ======= */
const API_BASE = 'https://script.google.com/macros/s/AKfycbxUf9oERSm53CpZQKkpp3mFXR3aLWc4tzSVW8DPHqsGvVt-keB_KtzAJiIgLMm9GYnB/exec';

/* ======= HELPERS ======= */
const EMPRESAS=['MERCATTO DELICIA','DELICIA GOURMET','VILLA GOURMET','M. KIDS','PADARIA DELICIA'];
const norm=s=>String(s||'').normalize('NFD').replace(/\p{Diacritic}/gu,'').replace(/[^A-Za-z0-9 ]/g,'').replace(/\s+/g,' ').trim().toUpperCase();
const moeda=v=>Number(v||0).toLocaleString('pt-BR',{style:'currency',currency:'BRL'});
const aliases=(obj,keys,def=0)=>{for(const k of keys){if(obj&&obj[k]!=null&&obj[k]!=='' && !isNaN(Number(obj[k]))) return Number(obj[k]);}return def;};
const idSafe=(p,k)=>`${p}-${norm(k).replace(/[^A-Z0-9]+/g,'-')}-${Math.random().toString(36).slice(2,6)}`;

/* ======= FONTE 9 TOTAL: pega pronto ou calcula (coluna C / listas) ======= */
function getFonte9Total(rec){
  const ready = ['totalFonte9','fonte9Total','valorCompradoFonte9','compradoFonte9','valorTotalComprado'];
  for(const k of ready){ if(rec && rec[k]!=null && rec[k]!=='' && !isNaN(Number(rec[k]))) return Number(rec[k]); }

  if (Array.isArray(rec?.fonte9Detalhe)) {
    const t = rec.fonte9Detalhe.reduce((a,i)=>a+Math.abs(Number(i.valor||i.total||0)),0);
    if (t) return t;
  }
  if (Array.isArray(rec?.categorias)) {
    let total=0;
    rec.categorias.forEach(cat=>{
      (cat.subs||[]).forEach(s=>{
        const f=Number(s.font);
        if (f===9 || s.isSub===true || s.font==null) total+=Math.abs(Number(s.valor||0));
      });
    });
    if (total) return total;
  }
  const lists=[rec?.todos,rec?.itens,rec?.rows,rec?.linhas];
  for(const L of lists){
    if(Array.isArray(L)){
      let total=0,any=false;
      L.forEach(r=>{
        const f=Number(r?.font);
        const v=Number(r?.valor ?? r?.total ?? 0);
        if (isNaN(f) || f===9){ total+=Math.abs(v); any=true; }
      });
      if(any) return total;
    }
  }
  if (Array.isArray(rec?.grid) && Array.isArray(rec.grid[0])) {
    let total=0,any=false;
    for(const row of rec.grid){ const v=Number(row[2]??0); if(isFinite(v)){ total+=Math.abs(v); any=true; } }
    if(any) return total;
  }
  if (Array.isArray(rec?.tabela) && Array.isArray(rec.tabela[0])) {
    let total=0,any=false;
    for(const row of rec.tabela){ const v=Number(row[2]??0); if(isFinite(v)){ total+=Math.abs(v); any=true; } }
    if(any) return total;
  }
  return 0;
}

/* ======= Série temporal: tenta extrair evolução da API (datas + valores) ======= */
function extractSeries(rec){
  // Normaliza vários formatos comuns que podem vir do Apps Script
  const candidates = rec?.series || rec?.historico || rec?.diario || rec?.timeline || rec?.evolucao || rec?.historicoDias || rec?.pontos || [];
  let arr = Array.isArray(candidates) ? candidates : [];

  // Alguns endpoints mandam {data:[], fonte9:[], fornecedores:[]}
  if (!arr.length && rec && Array.isArray(rec.datas) && (Array.isArray(rec.fonte9) || Array.isArray(rec.fornecedores))){
    arr = rec.datas.map((d,i)=>({
      data: d,
      fonte9: Number(rec.fonte9?.[i] ?? 0),
      fornecedores: Number(rec.fornecedores?.[i] ?? 0)
    }));
  }

  // Mapeia para {label, f9, forn}
  const out = [];
  arr.forEach(p=>{
    const label = p.label || p.dia || p.data || p.date || p.dt || p.mes || p.periodo || '';
    const f9 = Number(
      p.f9 ?? p.fonte9 ?? p.totalFonte9 ?? p.valorCompradoFonte9 ?? p.compradoFonte9 ?? p.c ?? p.colC ?? p.valor ?? p.total ?? 0
    );
    const forn = Number(
      p.fornecedores ?? p.fornecedoresComprado ?? p.valorCompradoFornecedores ?? p.compradoFornecedores ?? p.cForn ?? 0
    );
    if(label) out.push({label:String(label), f9:isFinite(f9)?f9:0, forn:isFinite(forn)?forn:0});
  });

  // Ordena por data se a label for algo tipo YYYY-MM-DD ou DD/MM
  out.sort((a,b)=>new Date(a.label)-new Date(b.label));
  return out;
}

/* ======= API ======= */
async function fetchTravasPorEmpresa(empresa, periodo){
  const qs = `?empresa=${encodeURIComponent(empresa)}${periodo?`&periodo=${encodeURIComponent(periodo)}`:''}`;
  const url = API_BASE + qs;
  const res = await fetch(url, {cache:'no-store'});
  const txt = await res.text();
  if(!res.ok) throw new Error(`HTTP ${res.status} • ${txt.slice(0,120)}`);
  let json; try{ json=JSON.parse(txt);}catch{ throw new Error('JSON inválido do endpoint'); }
  if(json?.ok===false) throw new Error(json.error||'Erro do endpoint');
  if (json?.empresa) return json;
  if (Array.isArray(json?.data)) return json.data.find(r=>norm(r.empresa||r.Empresa)===norm(empresa)) || json.data[0];
  if (Array.isArray(json)) return json.find(r=>norm(r.empresa||r.Empresa)===norm(empresa)) || json[0];
  return json;
}

/* ======= UI ======= */
document.getElementById('empresa').addEventListener('change', run);
document.getElementById('periodo').addEventListener('change', run);

// Coloca o mês atual por padrão
window.addEventListener('DOMContentLoaded', () => {
  const hoje = new Date();
  document.getElementById('periodo').value = hoje.toISOString().slice(0,7); // YYYY-MM
  run();
});

/* ======= RENDER ======= */
async function run(){
  const empSel=document.getElementById('empresa').value;
  const periodo=document.getElementById('periodo').value;
  const container=document.getElementById('content');
  container.innerHTML='<div style="padding:12px;color:#64748b">Carregando…</div>';

  const empresas = empSel==='TODAS AS EMPRESAS' ? EMPRESAS : [empSel];
  const parts=[];

  for(const emp of empresas){
    try{
      const rec = await fetchTravasPorEmpresa(emp, periodo);
      if(!rec){ parts.push(renderErro(emp,'Sem dados.')); continue; }

      const travaTotal = aliases(rec, ['travaTotal','trava_total','E2','travaTotalE2'], 0);          // E2
      const fornecLim  = aliases(rec, ['travaCompras','trava_compras','fornecedoresTotal','D2'], 0); // D2
      let fonte9Tot    = aliases(rec, ['totalFonte9','fonte9Total','valorCompradoFonte9','compradoFonte9','valorTotalComprado'], 0);
      if (!fonte9Tot)  fonte9Tot = getFonte9Total(rec); // calcula se não vier pronto
      const fornComp   = aliases(rec, ['fornecedoresComprado','valorCompradoFornecedores','compradoFornecedores','C2_C19'], 0);
      const pctTotal = travaTotal>0 ? (fonte9Tot/travaTotal*100) : 0;
      const pctFor   = fornecLim>0  ? (fornComp/fornecLim*100)   : 0;
      const detRaw   = rec.fornecedoresDetalhe || rec.detalhesFornecedores || rec.detalhamento || [];
      const det = [...detRaw].map(d=>({ 
        nome: d.nome ?? d.planocontas ?? d.categoria ?? '—',
        valor: Number(d.valor ?? d.total ?? 0)
      })).sort((a,b)=>Math.abs(b.valor)-Math.abs(a.valor));

      // Série temporal (só mostra quando tiver 1 empresa selecionada)
      const serie = empSel==='TODAS AS EMPRESAS' ? [] : extractSeries(rec);

      parts.push(renderEmpresa(emp,{travaTotal,fonte9Tot,fornecLim,fornComp,pctTotal,pctFor,det,serie}));
    }catch(e){
      parts.push(renderErro(emp, e.message||String(e)));
    }
  }

  container.innerHTML = parts.join('');
}

/* ======= TEMPLATES ======= */
function renderErro(emp,msg){
  return `<section class="company">
    <div class="title">${emp}</div>
    <div style="background:#fff3f3;color:#991b1b;border-radius:12px;padding:12px;box-shadow:0 1px 8px rgba(0,0,0,.06)">
      Erro: ${msg}
    </div>
  </section>`;
}

function renderEmpresa(emp, data){
  const {travaTotal,fonte9Tot,fornecLim,fornComp,pctTotal,pctFor,det,serie} = data;
  const cardForId=idSafe('cardFor', emp);
  const chartId=idSafe('chart','evolucao');

  const chartBlock = (Array.isArray(serie) && serie.length>0) ? `
    <div class="card">
      <div class="title">Evolução do Mês</div>
      <canvas id="${chartId}"></canvas>
    </div>` : '';

  const html = `
  <section class="company">
    <div class="title">${emp}</div>
    <div class="kpis">
      <div class="kpi">
        <div class="label">Trava Total (E2)</div>
        <div class="value">${moeda(travaTotal)}</div>
      </div>
      <div class="kpi ${pctTotal>=80?'red':''}">
        <div class="label">Valor Total Comprado (Fonte 9)</div>
        <div class="value">${moeda(fonte9Tot)}</div>
        <div class="hint">${pctTotal.toFixed(1)}%</div>
      </div>
    </div>
    <div class="kpis">
      <div class="kpi">
        <div class="label">Fornecedores Total (D2)</div>
        <div class="value">${moeda(fornecLim)}</div>
      </div>
      <div class="kpi ${pctFor>=80?'red':''}" id="${cardForId}" style="cursor:pointer">
        <div class="label">Valor Já Comprado (Fornecedores · C2→C19)</div>
        <div class="value">${moeda(fornComp)}</div>
        <div class="hint">${pctFor.toFixed(1)}%</div>
      </div>
    </div>

    <div class="grid">
      ${chartBlock}
    </div>
  </section>`;

  // evento de modal + gráfico
  queueMicrotask(()=>{
    // Modal fornecedores (ordenado do maior para o menor)
    const el=document.getElementById(cardForId);
    if(el){
      el.addEventListener('click',()=>{
        const title=document.getElementById('modal-title');
        title.textContent=`Detalhamento Fornecedores — ${emp}`;
        const ul=document.getElementById('modal-list'); ul.innerHTML='';
        (det||[]).forEach(d=>{
          const li=document.createElement('li');
          li.textContent = `${d.nome} — ${moeda(Math.abs(Number(d.valor||0)))}`;
          ul.appendChild(li);
        });
        document.getElementById('modal').style.display='flex';
      });
    }

    // Gráfico de linhas (só se existir série)
    if (chartId && document.getElementById(chartId) && Array.isArray(serie) && serie.length>0){
      const ctx=document.getElementById(chartId).getContext('2d');
      const labels = serie.map(p=>p.label);
      const f9 = serie.map(p=>p.f9||0);
      const forn = serie.map(p=>p.forn||0);
      new Chart(ctx,{
        type:'line',
        data:{
          labels,
          datasets:[
            { label:'Fonte 9 (Total Comprado)', data:f9, tension:.25 },
            { label:'Fornecedores (C2→C19)', data:forn, tension:.25 }
          ]
        },
        options:{ responsive:true, plugins:{ legend:{position:'bottom'} }, scales:{ y:{ beginAtZero:true } } }
      });
    }
  });

  return html;
}
</script>
</body>
</html>
