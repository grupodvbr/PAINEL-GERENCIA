<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8" />
<title>CB Systems â€¢ Painel do Gestor</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
  :root{
    --bg:#f6f8fb; --ink:#0f172a; --muted:#64748b; --card:#fff; --primary:#0ea5e9;
    --ok:#22c55e; --warn:#f59e0b; --bad:#ef4444; --shadow:0 1px 8px rgba(0,0,0,.06)
  }
  *{box-sizing:border-box}
  body{background:var(--bg);color:var(--ink);font-family:'Segoe UI',system-ui,-apple-system,sans-serif;margin:0}
  header{position:sticky;top:0;z-index:10;background:#0b1220;color:#fff;padding:14px 18px;font-weight:700;box-shadow:0 2px 12px rgba(0,0,0,.25)}
  .wrap{padding:18px;max-width:1400px;margin:0 auto}
  .filters{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:10px;background:var(--card);border-radius:14px;padding:12px;box-shadow:var(--shadow)}
  select,input[type="month"],button{padding:10px 12px;border:1px solid #e5e7eb;border-radius:10px;font-size:14px}
  button{background:var(--primary);color:#fff;border:none;cursor:pointer}
  button:hover{filter:brightness(.95)}
  .section{margin-top:16px}
  .company{background:transparent}
  .company > .title{font-weight:800;margin:10px 2px 8px}
  .kpis{display:grid;grid-template-columns:repeat(auto-fit,minmax(240px,1fr));gap:10px}
  .kpi{background:var(--card);border-radius:14px;padding:12px;box-shadow:var(--shadow)}
  .kpi .label{color:var(--muted);font-size:12px;margin-bottom:4px}
  .kpi .value{font-size:22px;font-weight:900}
  .kpi .hint{color:var(--muted);font-size:12px}
  .grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(320px,1fr));gap:14px;margin-top:12px}
  .card{background:var(--card);border-radius:14px;padding:14px;box-shadow:var(--shadow)}
  .card .title{font-weight:700;margin-bottom:8px}
  .pill{display:inline-flex;align-items:center;gap:6px;padding:6px 10px;border-radius:999px;font-size:12px}
  .ok{background:#ecfdf5;color:#065f46}.warn{background:#fffbeb;color:#92400e}.bad{background:#fef2f2;color:#991b1b}
  ul{margin:8px 0 0;padding-left:18px}
  li+li{margin-top:6px}
  canvas{max-width:100%}
</style>
</head>
<body>
<header>CB Systems â€¢ Painel do Gestor</header>

<div class="wrap">
  <div class="filters">
    <label>Empresa
      <select id="empresa">
        <option>TODAS AS EMPRESAS</option>
        <option>MERCATTO DELICIA</option>
        <option>DELICIA GOURMET</option>
        <option>VILLA GOURMET</option>
        <option>M. KIDS</option>
        <option>PADARIA DELICIA</option>
      </select>
    </label>
    <label>UsuÃ¡rio
      <select id="usuario">
        <option>Lucas</option><option>Maria</option><option>JoÃ£o</option>
        <option>PatrÃ­cia</option><option>Carlos</option><option>Fernanda</option>
        <option>Bruno</option><option>Ana</option><option>Roberto</option>
      </select>
    </label>
    <label>PerÃ­odo
      <input id="periodo" type="month" />
    </label>
    <div style="display:flex;align-items:end"><button id="btn" title="Atualizar">Entrar</button></div>
  </div>

  <div id="content" class="section"></div>
</div>

<script>
/* --------------------- ENDPOINTS --------------------- */
const URL_METAS  = 'https://script.google.com/macros/s/AKfycbziCPWWJxxfrnSeT3RHsNbw21z9MfnnB8JpV7ZQcZnvUQQ7dL3lVJdpUG7epACVjFaO/exec';   // TEXT
const URL_CANCEL = 'https://script.google.com/macros/s/AKfycbzM1mmixFkFE5tbC-0Evc6GVyZEJkh88HCikNK08FujRwCrgUA1e_E29nMHip81kRPoSg/exec'; // TEXT
const URL_SAT    = 'https://script.google.com/macros/s/AKfycbyK3A5CDn_EgA3pbRVToh87_qKWvbIry886OkR1AdkJi7RyvSgcwY0BmRqhbKQnEKwgrA/exec'; // JSON
const URL_TRAVAS = 'https://script.google.com/macros/s/AKfycbzkj-mfUUqwetIY5JKj0zPpTftzgVqCDFJLu45PlznBAGF4xm97EHnZQwqYUfhsS_1lFA/exec'; // JSON

/* --------------------- HELPERS --------------------- */
const EMPRESAS = ['MERCATTO DELICIA','DELICIA GOURMET','VILLA GOURMET','M. KIDS','PADARIA DELICIA'];
const MAP_TRAVAS = {
  'MERCATTO DELICIA':'MERCATTO DELICIA', // se o endpoint usar â€œMERCATTOâ€, troque aqui
  'DELICIA GOURMET':'DELICIA GOURMET',
  'VILLA GOURMET':'VILLA GOURMET',
  'M. KIDS':'M. KIDS',
  'PADARIA DELICIA':'PADARIA DELICIA'
};

const norm = s => String(s||'').normalize('NFD').replace(/\p{Diacritic}/gu,'')
                   .replace(/[^A-Za-z0-9 ]/g,'').replace(/\s+/g,' ').trim().toUpperCase();
const moeda = v => Number(v||0).toLocaleString('pt-BR',{style:'currency',currency:'BRL'});
function num(v){ const s=String(v||'').replace(/[^0-9,.-]/g,'').replace(/\.(?=\d{3})/g,'').replace(',','.'); const n=parseFloat(s); return isNaN(n)?0:n; }
function pill(txt,kind){ return `<span class="pill ${kind}">${txt}</span>`; }
function idOf(base){ return `${base}-${Math.random().toString(36).slice(2,8)}`; }

/* fonte 9: subcategorias; fonte 10: categorias â€” sÃ³ somamos FONTE 9 */
function somasPorFonte9(t){
  const categorias = Array.isArray(t?.categorias) ? t.categorias : [];
  const pickFont9 = s => (s && (s.font === 9 || s.isSub === true || s.font == null));
  const allSubs9  = categorias.flatMap(c => (c.subs||[]).filter(pickFont9));
  const totalGeral9 = allSubs9.reduce((acc,s)=>acc + Math.abs(Number(s.valor||0)),0);

  const catFor = categorias.find(c => norm(c.nome).includes('FORNECEDOR'));
  const forSubs9 = (catFor?.subs||[]).filter(pickFont9);
  const fornecedores9 = forSubs9.reduce((acc,s)=>acc + Math.abs(Number(s.valor||0)),0);

  return { totalGeral9, fornecedores9, forSubs9 };
}

/* --------------------- PARSERS TEXTO --------------------- */
function parseMetasTexto(text){
  const linhas = text.split(/\r?\n/).map(l=>l.trim());
  const out=[]; let emp=null;
  for(let i=0;i<linhas.length;i++){
    const l=linhas[i];
    if(/^[A-ZÃÃƒÃ‚Ã‰ÃŠÃÃ“Ã”Ã•ÃšÃ‡\.\s\-]+$/.test(l) && !/ANÃLISE|ATUALIZADO/i.test(l)) emp=l.replace(/[*â€¢]/g,'').trim();
    const mMeta=l.match(/Meta:\s*R\$\s*([0-9\._.,]+)/i);
    if(mMeta){
      const metaVal=num(mMeta[1]); let real=0;
      for(let j=i+1;j<i+5 && j<linhas.length;j++){
        const mR=linhas[j].match(/Realizado:\s*R\$\s*([0-9\._.,]+)/i);
        if(mR){ real=num(mR[1]); break; }
      }
      if(emp) out.push({empresa:emp, meta:metaVal, realizado:real});
    }
  }
  return out;
}
function parseCancelamentosTexto(text){
  const linhas=text.split(/\r?\n/); const out=[]; let empresa=null; let itens=[]; let total=0;
  const push=()=>{ if(empresa) out.push({empresa,itens:[...itens],total}); };
  for(const raw of linhas){
    const l=raw.trim();
    const cab=l.match(/^\*\s*([^*\-â€“]+?)\s*[\-â€“]\s*R\$\s*([0-9\._.,]+)/);
    if(cab){ push(); empresa=cab[1].trim(); itens=[]; total=num(cab[2]); continue; }
    const it=l.match(/^(?:[\p{Emoji}\p{So}\p{Sk}\p{Sc}\p{P}]{1,3})?\s*([^\-â€“]+?)\s*[\-â€“]\s*R\$\s*([0-9\._.,]+)/u);
    if(it && empresa){ itens.push({nome:it[1].trim(), valor:num(it[2])}); }
  }
  push(); return out;
}
function aggregateSatisfacao(arr){
  const map={}; const bucket=w=>{const s=String(w||'').toLowerCase();
    if(s.startsWith('Ã³tim')||s.startsWith('otim'))return 'Excelente';
    if(s.startsWith('bom'))return 'Bom';
    if(s.startsWith('regular'))return 'Regular';
    if(s.startsWith('ruim'))return 'Ruim';
    return null;};
  const fields=['ambiente','atendimento','comida','musica','climatizacao','bebidas','iluminacao'];
  arr.forEach(r=>{ const k=norm(r.empresa||r.Empresa||'');
    if(!map[k]) map[k]={Excelente:0,Bom:0,Regular:0,Ruim:0};
    fields.forEach(f=>{ const b=bucket(r[f]); if(b) map[k][b]++; });
  });
  return map;
}

/* --------------------- RENDER --------------------- */
document.getElementById('btn').addEventListener('click', run);

async function run(){
  const empSel = document.getElementById('empresa').value;
  const periodo = document.getElementById('periodo').value;
  const qs = periodo ? `?periodo=${encodeURIComponent(periodo)}` : '';

  // Carrega fontes (1x)
  const [metasTxt, cancelTxt, satJson] = await Promise.all([
    fetch(URL_METAS + qs).then(r=>r.text()).catch(()=>''),       // TEXT
    fetch(URL_CANCEL + qs).then(r=>r.text()).catch(()=>''),      // TEXT
    fetch(URL_SAT + qs).then(r=>r.json()).catch(()=>[])          // JSON
  ]);
  const metas  = parseMetasTexto(metasTxt);
  const cancel = parseCancelamentosTexto(cancelTxt);
  const satAgg = aggregateSatisfacao(satJson);

  const empresas = empSel === 'TODAS AS EMPRESAS' ? EMPRESAS : [empSel];
  const container = document.getElementById('content');
  container.innerHTML = '';

  // Render por empresa
  for(const emp of empresas){
    const empNorm = norm(emp);
    const travasNome = MAP_TRAVAS[emp] || emp;
    const travasKey  = norm(travasNome);

    // Busca TRAVAS por empresa (para evitar latÃªncia acumulada, poderia paralelizar; aqui mantemos simples/estÃ¡vel)
    let travasArr = await fetch(URL_TRAVAS + (qs + (qs?'&':'?') + 'empresa=' + encodeURIComponent(travasNome)))
                        .then(r=>r.json()).catch(()=>[]);
    if(!Array.isArray(travasArr) || travasArr.length===0){
      travasArr = await fetch(URL_TRAVAS + (qs + (qs?'&':'?') + 'empresa=' + encodeURIComponent(emp)))
                        .then(r=>r.json()).catch(()=>[]);
    }
    let trav = null;
    if(Array.isArray(travasArr)){
      trav = travasArr.find(x=> norm(x.empresa)===travasKey)
         ||  travasArr.find(x=> norm(x.empresa)===empNorm)
         ||  travasArr[0] || null;
    }

    const m = metas.find(x=> norm(x.empresa)===empNorm) || {meta:0,realizado:0};
    const c = cancel.find(x=> norm(x.empresa)===empNorm) || {itens:[], total:0};

    // Regras da planilha (fonte 9)
    const { totalGeral9, fornecedores9, forSubs9 } = somasPorFonte9(trav||{});
    const travaCompras   = trav? Number(trav.travaCompras||0) : 0;
    const travaTotalCalc = totalGeral9;
    const fornecAbs      = fornecedores9;
    const sobra          = travaCompras - fornecAbs;
    const consumoPct     = travaCompras>0 ? (fornecAbs/travaCompras*100) : 0;

    // monta seÃ§Ã£o da empresa
    const sec = document.createElement('section'); sec.className='company';
    sec.innerHTML = `
      <div class="title">${emp}</div>
      <div class="kpis">
        <div class="kpi"><div class="label">Meta de Compras</div><div class="value">${moeda(m.meta)}</div><div class="hint">â€”</div></div>
        <div class="kpi"><div class="label">Compras Realizadas</div><div class="value">${moeda(m.realizado)}</div><div class="hint">${m.meta>0?(m.realizado/m.meta*100).toFixed(1):'0.0'}% do limite</div></div>
        <div class="kpi"><div class="label">Cancelamentos (R$)</div><div class="value">${moeda(c.total)}</div><div class="hint">${(c.itens||[]).length} itens</div></div>
        <div class="kpi"><div class="label">Trava de Compras</div><div class="value">${trav?moeda(travaCompras):'â€”'}</div><div class="hint">${trav?consumoPct.toFixed(1)+'% consumidos':'â€”'}</div></div>
        <div class="kpi"><div class="label">Trava Total (Geral)</div><div class="value">${trav?moeda(travaTotalCalc):'â€”'}</div><div class="hint">somente fonte 9</div></div>
        <div class="kpi"><div class="label">Fornecedores (Total)</div><div class="value">${trav?moeda(fornecAbs):'â€”'}</div><div class="hint">${trav?(sobra>=0?'Sobra: ':'Estouro: ')+moeda(Math.abs(sobra)):'â€”'}</div></div>
      </div>
      <div class="grid">
        <div class="card">
          <div class="title">Metas x Realizado</div>
          <canvas id="${idOf('metas')}"></canvas>
          <div class="hint" style="margin-top:8px">${(m.meta>0?(m.realizado/m.meta*100):0)>100? pill('ðŸš¨ Estouro','bad'): pill('âœ… Dentro do limite','ok')}</div>
        </div>
        <div class="card">
          <div class="title">Cancelamentos (Top itens)</div>
          <canvas id="${idOf('canc')}"></canvas>
          <ul id="${idOf('lc')}"></ul>
        </div>
        <div class="card">
          <div class="title">Trava de Compras â€¢ Top Subcategorias (Fornecedores)</div>
          <canvas id="${idOf('forcats')}"></canvas>
          <ul id="${idOf('lf')}"></ul>
        </div>
        <div class="card">
          <div class="title">SatisfaÃ§Ã£o dos Clientes</div>
          <canvas id="${idOf('sat')}"></canvas>
        </div>
      </div>
    `;
    container.appendChild(sec);

    // pega ids reais criados
    const canvases = sec.querySelectorAll('canvas');
    const [ctxMetas, ctxCanc, ctxForCats, ctxSat] = [...canvases].map(c=>c.getContext('2d'));
    // metas
    new Chart(ctxMetas, { type:'bar',
      data:{ labels:['Meta','Realizado'], datasets:[{ data:[m.meta||0, m.realizado||0] }] },
      options:{ responsive:true, plugins:{ legend:{display:false} }, scales:{ y:{ beginAtZero:true } } }
    });
    // cancelamentos
    const topCancel = [...(c.itens||[])].sort((a,b)=>b.valor-a.valor).slice(0,10);
    new Chart(ctxCanc, { type:'bar',
      data:{ labels: topCancel.map(i=>i.nome), datasets:[{ data: topCancel.map(i=>i.valor) }] },
      options:{ responsive:true, plugins:{ legend:{display:false} }, scales:{ y:{ beginAtZero:true } }, indexAxis:'x' }
    });
    const listCanc = sec.querySelector('ul[id^="lc-"]'); listCanc.innerHTML='';
    topCancel.slice(0,5).forEach(i=>{ const li=document.createElement('li'); li.textContent = `${i.nome} â€” ${moeda(i.valor)}`; listCanc.appendChild(li); });

    // fornecedores top subcategorias (fonte 9)
    const topSubs = [...(forSubs9||[])].sort((a,b)=>Math.abs(b.valor)-Math.abs(a.valor)).slice(0,10);
    new Chart(ctxForCats, { type:'bar',
      data:{ labels: topSubs.map(s=>s.nome), datasets:[{ data: topSubs.map(s=>Math.abs(s.valor||0)) }] },
      options:{ responsive:true, plugins:{ legend:{display:false} }, scales:{ y:{ beginAtZero:true } } }
    });
    const listFor = sec.querySelector('ul[id^="lf-"]'); listFor.innerHTML='';
    topSubs.forEach(s=>{ const li=document.createElement('li'); li.textContent = `${s.nome} â€” ${moeda(s.valor)}${s.pctDaTrava?' â€¢ '+s.pctDaTrava.toFixed(1)+'%':''}`; listFor.appendChild(li); });

    // satisfaÃ§Ã£o
    const sat = satAgg[empNorm] || {Excelente:0,Bom:0,Regular:0,Ruim:0};
    new Chart(ctxSat, { type:'pie',
      data:{ labels:['Excelente','Bom','Regular','Ruim'],
        datasets:[{ data:[sat.Excelente,sat.Bom,sat.Regular,sat.Ruim],
          backgroundColor:['#22c55e','#0ea5e9','#f59e0b','#ef4444'] }]},
      options:{ responsive:true, plugins:{ legend:{ position:'bottom' } } }
    });
  }
}
</script>
</body>
</html>
