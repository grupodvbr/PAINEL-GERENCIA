<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8" />
<title>CB Systems • Painel de Travas</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
  :root{
    --bg:#f6f8fb; --ink:#0f172a; --muted:#64748b; --card:#fff; --primary:#0ea5e9; --shadow:0 1px 8px rgba(0,0,0,.06);
    --red:#b91c1c; --green:#065f46; --amber:#92400e; --redbg:#fef2f2; --greenbg:#ecfdf5; --amberbg:#fffbeb;
  }
  *{box-sizing:border-box}
  body{background:var(--bg);color:var(--ink);font-family:'Segoe UI',system-ui,-apple-system,sans-serif;margin:0}
  header{position:sticky;top:0;z-index:10;background:#0b1220;color:#fff;padding:14px 18px;font-weight:700;box-shadow:0 2px 12px rgba(0,0,0,.25)}
  .wrap{padding:16px;max-width:1200px;margin:0 auto}
  .filters{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:10px;background:var(--card);border-radius:14px;padding:12px;box-shadow:var(--shadow)}
  select,input[type="month"]{width:100%;padding:10px 12px;border:1px solid #e5e7eb;border-radius:10px;font-size:14px;background:#fff}
  .section{margin-top:14px}
  .company>.title{font-weight:800;margin:10px 2px 12px}
  /* 2 cards por linha no mobile e desktop, e cards compactos */
  .kpis{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:10px}
  .kpi{background:var(--card);border-radius:14px;padding:10px;box-shadow:var(--shadow);touch-action:manipulation;position:relative}
  .kpi .label{color:var(--muted);font-size:11px;margin-bottom:4px}
  .kpi .value{font-size:18px;font-weight:900}
  .kpi .hint{color:var(--muted);font-size:11px;margin-top:2px}
  .kpi.bad{background:var(--redbg);color:var(--red)}
  .kpi.good{background:var(--greenbg);color:var(--green)}
  .kpi.warn{background:var(--amberbg);color:var(--amber)}
  .badge{position:absolute;top:8px;right:8px;font-size:10px;padding:3px 6px;border-radius:999px;background:#e5e7eb;color:#111}
  .badge.red{background:#fecaca;color:#7f1d1d}
  .badge.green{background:#bbf7d0;color:#065f46}
  .badge.amber{background:#fde68a;color:#78350f}
  .progress{height:6px;background:#e5e7eb;border-radius:999px;margin-top:8px;overflow:hidden}
  .progress>span{display:block;height:100%;background:var(--primary);width:0;border-radius:999px;transition:width .2s}

  .grid{display:grid;grid-template-columns:1fr;gap:12px;margin-top:12px}
  .card{background:var(--card);border-radius:14px;padding:12px;box-shadow:var(--shadow)}
  .card .title{font-weight:700;margin-bottom:8px}
  .list{margin:0;padding-left:18px}
  .list li+li{margin-top:6px}

  /* Modal */
  #modal{display:none;position:fixed;inset:0;z-index:1000;align-items:center;justify-content:center}
  #modal .backdrop{position:absolute;inset:0;background:rgba(0,0,0,.45)}
  #modal .panel{position:relative;z-index:1;width:min(94vw,680px);max-height:80vh;overflow:auto;background:#fff;border-radius:12px;box-shadow:0 10px 30px rgba(0,0,0,.25);padding:12px}
  #modal header{position:sticky;top:0;background:#fff;margin:-12px -12px 8px;padding:10px 12px;border-radius:12px 12px 0 0;box-shadow:0 1px 0 rgba(0,0,0,.06)}
  #modal h3{margin:0;font-size:16px}
  #modal .close{appearance:none;border:none;background:transparent;font-size:22px;line-height:1;cursor:pointer;color:#334155}
  #modal .list{list-style:none;margin:0;padding:0}
  #modal .item{display:flex;justify-content:space-between;gap:12px;padding:10px;border-bottom:1px dashed #e5e7eb}
  #modal .item b{font-weight:600}
  #modal .item .val{white-space:nowrap}
  .empty{color:#6b7280;font-size:13px;padding:8px}
</style>
</head>
<body>
<header>CB Systems • Painel de Travas</header>

<div class="wrap">
  <div class="filters">
    <label>Empresa
      <select id="empresa">
        <option>TODAS AS EMPRESAS</option>
        <option>MERCATTO DELICIA</option>
        <option>DELICIA GOURMET</option>
        <option>VILLA GOURMET</option>
        <option>M. KIDS</option>
        <option>PADARIA DELICIA</option>
      </select>
    </label>
    <label>Período
      <input id="periodo" type="month" />
    </label>
  </div>

  <div id="content" class="section"></div>
</div>

<!-- Modal -->
<div id="modal" aria-hidden="true">
  <div class="backdrop" data-close></div>
  <div class="panel" role="dialog" aria-modal="true" aria-labelledby="modal-title">
    <header style="display:flex;align-items:center;justify-content:space-between">
      <h3 id="modal-title">Detalhamento Fornecedores</h3>
      <button class="close" title="Fechar" aria-label="Fechar" data-close>&times;</button>
    </header>
    <ul id="modal-list" class="list"></ul>
    <div id="modal-empty" class="empty" style="display:none">Sem itens para exibir.</div>
  </div>
</div>

<script>
/* ======= ENDPOINT ======= */
const API_BASE='https://script.google.com/macros/s/AKfycbxUf9oERSm53CpZQKkpp3mFXR3aLWc4tzSVW8DPHqsGvVt-keB_KtzAJiIgLMm9GYnB/exec';

/* ======= HELPERS ======= */
const EMPRESAS=['MERCATTO DELICIA','DELICIA GOURMET','VILLA GOURMET','M. KIDS','PADARIA DELICIA'];
const norm=s=>String(s||'').normalize('NFD').replace(/\p{Diacritic}/gu,'').replace(/[^A-Za-z0-9 ]/g,'').replace(/\s+/g,' ').trim().toUpperCase();
const moeda=v=>Number(v||0).toLocaleString('pt-BR',{style:'currency',currency:'BRL'});
const aliases=(obj,keys,def=0)=>{for(const k of keys){if(obj&&obj[k]!=null&&obj[k]!==''&&!isNaN(Number(obj[k])))return Number(obj[k]);}return def;};
const idSafe=(p,k)=>`${p}-${norm(k).replace(/[^A-Z0-9]+/g,'-')}-${Math.random().toString(36).slice(2,6)}`;

/* ======= Datas / previsão ======= */
function parsePeriodoYYYYMM(per){ // "2025-08" -> Date at first day
  if(!per) return null;
  const [y,m]=per.split('-').map(Number);
  if(!y||!m) return null;
  return new Date(y, m-1, 1); // local
}
function daysInMonth(date){ return new Date(date.getFullYear(), date.getMonth()+1, 0).getDate(); }
function monthCompare(a,b){ // -1 a<b, 0 equal month, 1 a>b
  if(a.getFullYear()===b.getFullYear() && a.getMonth()===b.getMonth()) return 0;
  if(a.getFullYear()<b.getFullYear() || (a.getFullYear()===b.getFullYear() && a.getMonth()<b.getMonth())) return -1;
  return 1;
}
function progressCalc(limit, spent, periodoStr){
  const today=new Date();
  const perDate=parsePeriodoYYYYMM(periodoStr) || new Date(today.getFullYear(), today.getMonth(), 1);
  const dim=daysInMonth(perDate);
  const cmp=monthCompare(perDate, new Date(today.getFullYear(), today.getMonth(), 1));
  let elapsed=0, remaining=0;
  if(cmp<0){ // mês passado
    elapsed=dim; remaining=0;
  }else if(cmp>0){ // mês futuro
    elapsed=0; remaining=dim;
  }else{ // mês corrente
    elapsed=Math.min(today.getDate(), dim);
    remaining=Math.max(dim - elapsed, 0);
  }
  const pct = limit>0 ? (spent/limit*100) : 0;
  const daily = elapsed>0 ? (spent/elapsed) : 0;
  const forecastSpent = spent + daily*remaining;
  const forecastPct = limit>0 ? (forecastSpent/limit*100) : 0;
  const available = limit - spent;

  // status visual:
  // - mês passado: final (spent vs limit)
  // - mês corrente: projetado (forecast vs limit)
  // - mês futuro: neutro (usa pct atual)
  let status='neutral'; // 'good','bad','warn'
  if(cmp<0){ // passado
    status = (spent>limit) ? 'bad' : 'good';
  }else if(cmp===0){ // corrente
    if(forecastSpent>limit) status='bad';
    else if(pct>=80) status='warn';
    else status='good';
  }else{ // futuro
    if(pct>=80) status='warn';
    else status='neutral';
  }
  return {pct, available, daily, forecastSpent, forecastPct, remaining, elapsed, dim, status, isPast:(cmp<0), isCurrent:(cmp===0)};
}

/* ======= Fonte 9 total ======= */
function getFonte9Total(rec){
  const ready=['totalFonte9','fonte9Total','valorCompradoFonte9','compradoFonte9','valorTotalComprado'];
  for(const k of ready){ if(rec && rec[k]!=null && rec[k]!=='' && !isNaN(Number(rec[k]))) return Number(rec[k]); }
  if(Array.isArray(rec?.fonte9Detalhe)){
    const t=rec.fonte9Detalhe.reduce((a,i)=>a+Math.abs(Number(i.valor||i.total||0)),0);
    if(t) return t;
  }
  if(Array.isArray(rec?.categorias)){
    let total=0;
    rec.categorias.forEach(cat=>{
      (cat.subs||[]).forEach(s=>{
        const f=Number(s.font);
        if(f===9 || s.isSub===true || s.font==null) total+=Math.abs(Number(s.valor||0));
      });
    });
    if(total) return total;
  }
  const lists=[rec?.todos,rec?.itens,rec?.rows,rec?.linhas];
  for(const L of lists){
    if(Array.isArray(L)){
      let total=0,any=false;
      L.forEach(r=>{
        const f=Number(r?.font);
        const v=Number(r?.valor ?? r?.total ?? 0);
        if(isNaN(f)||f===9){ total+=Math.abs(v); any=true; }
      });
      if(any) return total;
    }
  }
  if(Array.isArray(rec?.grid)&&Array.isArray(rec.grid[0])){
    let total=0,any=false;
    for(const row of rec.grid){ const v=Number(row[2]??0); if(isFinite(v)){ total+=Math.abs(v); any=true; } }
    if(any) return total;
  }
  if(Array.isArray(rec?.tabela)&&Array.isArray(rec.tabela[0])){
    let total=0,any=false;
    for(const row of rec.tabela){ const v=Number(row[2]??0); if(isFinite(v)){ total+=Math.abs(v); any=true; } }
    if(any) return total;
  }
  return 0;
}

/* ======= Série temporal (evolução) ======= */
function extractSeries(rec){
  let arr = rec?.series || rec?.historico || rec?.diario || rec?.timeline || rec?.evolucao || rec?.historicoDias || [];
  if(!Array.isArray(arr)) arr=[];
  if(!arr.length && rec && Array.isArray(rec.datas) && (Array.isArray(rec.fonte9)||Array.isArray(rec.fornecedores))){
    arr=rec.datas.map((d,i)=>({data:d,fonte9:Number(rec.fonte9?.[i]??0),fornecedores:Number(rec.fornecedores?.[i]??0)}));
  }
  const out=[];
  arr.forEach(p=>{
    const label = p.label||p.dia||p.data||p.date||p.dt||p.mes||p.periodo||'';
    const f9 = Number(p.f9??p.fonte9??p.totalFonte9??p.valorCompradoFonte9??p.compradoFonte9??p.c??p.colC??p.valor??p.total??0);
    const forn = Number(p.fornecedores??p.fornecedoresComprado??p.valorCompradoFornecedores??p.compradoFornecedores??p.cForn??0);
    if(label) out.push({label:String(label),f9:isFinite(f9)?f9:0,forn:isFinite(forn)?forn:0});
  });
  out.sort((a,b)=>new Date(a.label)-new Date(b.label));
  return out;
}

/* ======= API ======= */
async function fetchTravasPorEmpresa(empresa, periodo){
  const qs=`?empresa=${encodeURIComponent(empresa)}${periodo?`&periodo=${encodeURIComponent(periodo)}`:''}`;
  const url=API_BASE+qs;
  const res=await fetch(url,{cache:'no-store'});
  const txt=await res.text();
  if(!res.ok) throw new Error(`HTTP ${res.status} • ${txt.slice(0,120)}`);
  let json; try{ json=JSON.parse(txt);}catch{ throw new Error('JSON inválido do endpoint'); }
  if(json?.ok===false) throw new Error(json.error||'Erro do endpoint');
  if(json?.empresa) return json;
  if(Array.isArray(json?.data)) return json.data.find(r=>norm(r.empresa||r.Empresa)===norm(empresa))||json.data[0];
  if(Array.isArray(json)) return json.find(r=>norm(r.empresa||r.Empresa)===norm(empresa))||json[0];
  return json;
}

/* ======= UI ======= */
const selEmpresa=document.getElementById('empresa');
const inpPeriodo=document.getElementById('periodo');
const container=document.getElementById('content');

selEmpresa.addEventListener('change', run, {passive:true});
inpPeriodo.addEventListener('change', run, {passive:true});
window.addEventListener('keydown', (e)=>{ if(e.key==='Escape') closeModal(); }, {passive:true});
window.addEventListener('DOMContentLoaded', ()=>{
  const hoje=new Date();
  inpPeriodo.value = hoje.toISOString().slice(0,7); // YYYY-MM
  run();
});

/* ======= Modal ======= */
function openModal(title, items){
  const modal=document.getElementById('modal');
  document.getElementById('modal-title').textContent=title||'Detalhes';
  const ul=document.getElementById('modal-list');
  const empty=document.getElementById('modal-empty');
  ul.innerHTML='';
  if(Array.isArray(items) && items.length){
    empty.style.display='none';
    items.forEach(d=>{
      const li=document.createElement('li'); li.className='item';
      const nome=document.createElement('b'); nome.textContent=d.nome||'—';
      const val=document.createElement('span'); val.className='val'; val.textContent=moeda(Math.abs(Number(d.valor||0)));
      li.appendChild(nome); li.appendChild(val); ul.appendChild(li);
    });
  }else{
    empty.style.display='block';
  }
  modal.style.display='flex';
  modal.setAttribute('aria-hidden','false');
}
function closeModal(){
  const modal=document.getElementById('modal');
  modal.style.display='none';
  modal.setAttribute('aria-hidden','true');
}
document.querySelectorAll('[data-close]').forEach(el=>el.addEventListener('click', closeModal, {passive:true}));

/* ======= Render ======= */
async function run(){
  const empSel=selEmpresa.value;
  const periodo=inpPeriodo.value;
  container.innerHTML='<div style="padding:10px;color:#64748b">Carregando…</div>';

  const empresas = empSel==='TODAS AS EMPRESAS' ? EMPRESAS : [empSel];
  const blocks=[];

  for(const emp of empresas){
    try{
      const rec=await fetchTravasPorEmpresa(emp, periodo);
      if(!rec){ blocks.push(renderErro(emp,'Sem dados.')); continue; }

      const travaTotal=aliases(rec,['travaTotal','trava_total','E2','travaTotalE2'],0);          // E2
      const fornecLim=aliases(rec,['travaCompras','trava_compras','fornecedoresTotal','D2'],0);  // D2
      let fonte9Tot=aliases(rec,['totalFonte9','fonte9Total','valorCompradoFonte9','compradoFonte9','valorTotalComprado'],0);
      if(!fonte9Tot) fonte9Tot=getFonte9Total(rec);
      const fornComp=aliases(rec,['fornecedoresComprado','valorCompradoFornecedores','compradoFornecedores','C2_C19'],0);

      // progresso / previsão
      const gTotal = progressCalc(travaTotal, fonte9Tot, periodo);  // total (fonte9 vs E2)
      const gForn  = progressCalc(fornecLim,  fornComp,  periodo);  // fornecedores (C2→C19 vs D2)

      // detalhamento fornecedores (ordenado)
      const detRaw=rec.fornecedoresDetalhe||rec.detalhesFornecedores||rec.detalhamento||[];
      const det=[...detRaw].map(d=>({nome:d.nome??d.planocontas??d.categoria??'—',valor:Number(d.valor??d.total??0)}))
                           .sort((a,b)=>Math.abs(b.valor)-Math.abs(a.valor));

      // série temporal: só quando 1 empresa selecionada
      const serie = (empSel==='TODAS AS EMPRESAS') ? [] : extractSeries(rec);

      blocks.push(renderEmpresa(emp,{travaTotal,fonte9Tot,fornecLim,fornComp,gTotal,gForn,det,serie,showChart: empSel!=='TODAS AS EMPRESAS'}));
    }catch(e){
      blocks.push(renderErro(emp, e.message||String(e)));
    }
  }

  container.innerHTML=blocks.join('');
}

/* ======= Templates ======= */
function renderErro(emp,msg){
  return `<section class="company">
    <div class="title">${emp}</div>
    <div class="kpi bad"><div class="label">Erro</div><div class="value" style="font-size:16px">${msg}</div></div>
  </section>`;
}

function kpiClassFromStatus(status){
  if(status==='bad') return 'bad';
  if(status==='good') return 'good';
  if(status==='warn') return 'warn';
  return '';
}
function badgeFromStatus(status, isPast, isCurrent){
  if(isPast) return (status==='bad')
    ? `<span class="badge red">Mês encerrado • Estourou</span>`
    : `<span class="badge green">Mês encerrado • OK</span>`;
  if(isCurrent){
    if(status==='bad') return `<span class="badge red">Previsão: vermelho</span>`;
    if(status==='warn') return `<span class="badge amber">Atenção</span>`;
    return `<span class="badge green">Previsão: verde</span>`;
  }
  return '';
}

function renderEmpresa(emp, d){
  const {travaTotal,fonte9Tot,fornecLim,fornComp,gTotal,gForn,det,serie,showChart}=d;
  const cardForId=idSafe('cardFor', emp);
  const chartId=idSafe('chart','evolucao');

  const chartBlock = (showChart && Array.isArray(serie) && serie.length>0) ? `
    <div class="card">
      <div class="title">Evolução do Mês</div>
      <canvas id="${chartId}" height="170"></canvas>
      <div class="title" style="margin-top:12px">Despesas mais caras (Top 10)</div>
      <ul class="list">
        ${det.slice(0,10).map(i=>`<li>${i.nome} — <b>${moeda(Math.abs(i.valor||0))}</b></li>`).join('')}
      </ul>
    </div>` : '';

  const html=`
  <section class="company">
    <div class="title">${emp}</div>

    <div class="kpis">
      <div class="kpi ${kpiClassFromStatus(gTotal.status)}">
        ${badgeFromStatus(gTotal.status, gTotal.isPast, gTotal.isCurrent)}
        <div class="label">Trava Total (E2)</div>
        <div class="value">${moeda(travaTotal)}</div>
        <div class="hint">
          Gasto: <b>${moeda(fonte9Tot)}</b> • ${gTotal.pct.toFixed(1)}%<br/>
          Disponível: <b>${moeda(gTotal.available)}</b><br/>
          Previsão fim do mês: <b>${moeda(gTotal.forecastSpent)}</b> (${gTotal.forecastPct.toFixed(1)}%)
        </div>
        <div class="progress"><span style="width:${Math.min(gTotal.pct,100)}%"></span></div>
      </div>

      <div class="kpi ${kpiClassFromStatus(gForn.status)}" id="${cardForId}" style="cursor:pointer">
        ${badgeFromStatus(gForn.status, gForn.isPast, gForn.isCurrent)}
        <div class="label">Fornecedores Total (D2)</div>
        <div class="value">${moeda(fornecLim)}</div>
        <div class="hint">
          Já comprado: <b>${moeda(fornComp)}</b> • ${gForn.pct.toFixed(1)}%<br/>
          Disponível: <b>${moeda(gForn.available)}</b><br/>
          Previsão fim do mês: <b>${moeda(gForn.forecastSpent)}</b> (${gForn.forecastPct.toFixed(1)}%)
        </div>
        <div class="progress"><span style="width:${Math.min(gForn.pct,100)}%"></span></div>
      </div>
    </div>

    <div class="grid">${chartBlock}</div>
  </section>`;

  // eventos e gráfico
  queueMicrotask(()=>{
    // popup de fornecedores (sempre abre, inclusive em "TODAS AS EMPRESAS")
    const el=document.getElementById(cardForId);
    if(el){
      const open = ()=>openModal(`Detalhamento Fornecedores — ${emp}`, det);
      el.addEventListener('click', open, {passive:true});
      el.addEventListener('touchend', open, {passive:true});
    }

    // gráfico
    if(showChart && document.getElementById(chartId) && Array.isArray(serie) && serie.length>0){
      const ctx=document.getElementById(chartId).getContext('2d');
      const labels=serie.map(p=>p.label);
      const f9=serie.map(p=>p.f9||0);
      const forn=serie.map(p=>p.forn||0);
      new Chart(ctx,{
        type:'line',
        data:{labels,datasets:[
          {label:'Fonte 9 (Total Comprado)',data:f9,tension:.25},
          {label:'Fornecedores (C2→C19)',data:forn,tension:.25}
        ]},
        options:{responsive:true,plugins:{legend:{position:'bottom'}},scales:{y:{beginAtZero:true}}}
      });
    }
  });

  return html;
}
</script>
</body>
</html>
