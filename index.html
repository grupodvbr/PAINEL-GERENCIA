<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8" />
<title>CB Systems • Painel do Gestor</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
  :root{--bg:#f6f8fb;--ink:#0f172a;--muted:#64748b;--card:#fff;--primary:#0ea5e9;--shadow:0 1px 8px rgba(0,0,0,.06)}
  *{box-sizing:border-box}
  body{background:var(--bg);color:var(--ink);font-family:'Segoe UI',system-ui,-apple-system,sans-serif;margin:0}
  header{position:sticky;top:0;z-index:10;background:#0b1220;color:#fff;padding:14px 18px;font-weight:700;box-shadow:0 2px 12px rgba(0,0,0,.25)}
  .wrap{padding:18px;max-width:1400px;margin:0 auto}
  .filters{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:10px;background:var(--card);border-radius:14px;padding:12px;box-shadow:var(--shadow)}
  select,input[type="month"],button{padding:10px 12px;border:1px solid #e5e7eb;border-radius:10px;font-size:14px}
  button{background:var(--primary);color:#fff;border:none;cursor:pointer}
  button:hover{filter:brightness(.95)}
  .section{margin-top:16px}
  .company>.title{font-weight:800;margin:10px 2px 8px}
  .kpis{display:grid;grid-template-columns:repeat(auto-fit,minmax(240px,1fr));gap:10px}
  .kpi{background:var(--card);border-radius:14px;padding:12px;box-shadow:var(--shadow)}
  .kpi .label{color:var(--muted);font-size:12px;margin-bottom:4px}
  .kpi .value{font-size:22px;font-weight:900}
  .kpi .hint{color:var(--muted);font-size:12px}
  .grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(320px,1fr));gap:14px;margin-top:12px}
  .card{background:var(--card);border-radius:14px;padding:14px;box-shadow:var(--shadow)}
  .card .title{font-weight:700;margin-bottom:8px}
  .pill{display:inline-flex;align-items:center;gap:6px;padding:6px 10px;border-radius:999px;font-size:12px}
  .ok{background:#ecfdf5;color:#065f46}.warn{background:#fffbeb;color:#92400e}.bad{background:#fef2f2;color:#991b1b}
  ul{margin:8px 0 0;padding-left:18px} li+li{margin-top:6px}
</style>
</head>
<body>
<header>CB Systems • Painel do Gestor</header>

<div class="wrap">
  <div class="filters">
    <label>Empresa
      <select id="empresa">
        <option>TODAS AS EMPRESAS</option>
        <option>MERCATTO DELICIA</option>
        <option>DELICIA GOURMET</option>
        <option>VILLA GOURMET</option>
        <option>M. KIDS</option>
        <option>PADARIA DELICIA</option>
      </select>
    </label>
    <label>Usuário
      <select id="usuario">
        <option>Lucas</option><option>Maria</option><option>João</option>
        <option>Patrícia</option><option>Carlos</option><option>Fernanda</option>
        <option>Bruno</option><option>Ana</option><option>Roberto</option>
      </select>
    </label>
    <label>Período
      <input id="periodo" type="month" />
    </label>
    <div style="display:flex;align-items:end"><button id="btn">Entrar</button></div>
  </div>
  <div id="content" class="section"></div>
</div>

<script>
// ---------- ENDPOINTS ----------
const URL_METAS  = 'https://script.google.com/macros/s/AKfycbziCPWWJxxfrnSeT3RHsNbw21z9MfnnB8JpV7ZQcZnvUQQ7dL3lVJdpUG7epACVjFaO/exec';
const URL_CANCEL = 'https://script.google.com/macros/s/AKfycbzM1mmixFkFE5tbC-0Evc6GVyZEJkh88HCikNK08FujRwCrgUA1e_E29nMHip81kRPoSg/exec';
const URL_SAT    = 'https://script.google.com/macros/s/AKfycbyK3A5CDn_EgA3pbRVToh87_qKWvbIry886OkR1AdkJi7RyvSgcwY0BmRqhbKQnEKwgrA/exec';
const URL_TRAVAS = 'https://script.google.com/macros/s/AKfycbzkj-mfUUqwetIY5JKj0zPpTftzgVqCDFJLu45PlznBAGF4xm97EHnZQwqYUfhsS_1lFA/exec';

// ---------- HELPERS ----------
const EMPRESAS=['MERCATTO DELICIA','DELICIA GOURMET','VILLA GOURMET','M. KIDS','PADARIA DELICIA'];
const MAP_TRAVAS={...EMPRESAS.reduce((a,e)=>(a[e]=e,a),{})};
const USER_EMP_MAP={
  'LUCAS':'MERCATTO DELICIA',
  'MARIA':'DELICIA GOURMET',
  'JOAO':'VILLA GOURMET',
  'PATRICIA':'M. KIDS',
  'CARLOS':'PADARIA DELICIA',
  'FERNANDA':'MERCATTO DELICIA',
  'BRUNO':'DELICIA GOURMET',
  'ANA':'VILLA GOURMET',
  'ROBERTO':'PADARIA DELICIA'
};
const norm=s=>String(s||'').normalize('NFD').replace(/\p{Diacritic}/gu,'').replace(/[^A-Za-z0-9 ]/g,'').replace(/\s+/g,' ').trim().toUpperCase();
const moeda=v=>Number(v||0).toLocaleString('pt-BR',{style:'currency',currency:'BRL'});
function num(v){const s=String(v||'').replace(/[^0-9,.-]/g,'').replace(/\.(?=\d{3})/g,'').replace(',','.');const n=parseFloat(s);return isNaN(n)?0:n;}
function pill(txt,kind){return `<span class="pill ${kind}">${txt}</span>`;}
function idOf(b){return `${b}-${Math.random().toString(36).slice(2,8)}`;}

// ---------- SOMA FONTE 9 ----------
function somasPorFonte9(t){
  const categorias=Array.isArray(t?.categorias)?t.categorias:[];
  const isFont9=s=>Number(s.font)===9 || s.isSub===true || s.font==null;
  const subs9=categorias.flatMap(c=>(c.subs||[]).filter(isFont9));
  const totalGeral9=subs9.reduce((a,s)=>a+Math.abs(Number(s.valor||0)),0);
  const catFor=categorias.find(c=>norm(c.nome).includes('FORNECEDOR'));
  const forSubs9=(catFor?.subs||[]).filter(isFont9);
  const fornecedores9=forSubs9.reduce((a,s)=>a+Math.abs(Number(s.valor||0)),0);
  return {totalGeral9, fornecedores9, forSubs9};
}

// ---------- PARSERS ----------
function parseMetasTexto(text){
  const linhas=text.split(/\r?\n/).map(l=>l.trim()), out=[]; let emp=null;
  for(let i=0;i<linhas.length;i++){
    const l=linhas[i];
    if(/^[A-ZÁÃÂÉÊÍÓÔÕÚÇ\.\s\-]+$/.test(l) && !/ANÁLISE|ATUALIZADO/i.test(l)) emp=l.replace(/[*•]/g,'').trim();
    const m=l.match(/Meta:\s*R\$\s*([0-9\._.,]+)/i);
    if(m){const meta=num(m[1]);let real=0;for(let j=i+1;j<i+5&&j<linhas.length;j++){const r=linhas[j].match(/Realizado:\s*R\$\s*([0-9\._.,]+)/i);if(r){real=num(r[1]);break;}} if(emp) out.push({empresa:emp,meta,realizado:real});}
  }
  return out;
}
function parseCancelTexto(text){
  const linhas=text.split(/\r?\n/), out=[]; let empresa=null,itens=[],total=0; const push=()=>{if(empresa) out.push({empresa,itens:[...itens],total});};
  for(const raw of linhas){
    const l=raw.trim();
    const cab=l.match(/^\*\s*([^*\-–]+?)\s*[\-–]\s*R\$\s*([0-9\._.,]+)/);
    if(cab){push();empresa=cab[1].trim();itens=[];total=num(cab[2]);continue;}
    const it=l.match(/^(?:[\p{Emoji}\p{So}\p{Sk}\p{Sc}\p{P}]{1,3})?\s*([^\-–]+?)\s*[\-–]\s*R\$\s*([0-9\._.,]+)/u);
    if(it && empresa){itens.push({nome:it[1].trim(),valor:num(it[2])});}
  } push(); return out;
}
function aggregateSatisfacao(arr){
  const map={},bucket=w=>{const s=String(w||'').toLowerCase(); if(s.startsWith('ótim')||s.startsWith('otim'))return 'Excelente'; if(s.startsWith('bom'))return 'Bom'; if(s.startsWith('regular'))return 'Regular'; if(s.startsWith('ruim'))return 'Ruim'; return null;};
  const fields=['ambiente','atendimento','comida','musica','climatizacao','bebidas','iluminacao'];
  arr.forEach(r=>{const k=norm(r.empresa||r.Empresa||''); if(!map[k]) map[k]={Excelente:0,Bom:0,Regular:0,Ruim:0}; fields.forEach(f=>{const b=bucket(r[f]); if(b) map[k][b]++;});});
  return map;
}

// ---------- EVENTOS ----------
document.getElementById('btn').addEventListener('click',()=>{
  const usuarioSel=document.getElementById('usuario').value;
  const empAuto=USER_EMP_MAP[norm(usuarioSel)] || 'TODAS AS EMPRESAS';
  document.getElementById('empresa').value=empAuto;
  run();
});
window.addEventListener('DOMContentLoaded', () => {
  const params=new URLSearchParams(location.search);
  const usuario=params.get('usuario');
  if(usuario){
    document.getElementById('usuario').value=decodeURIComponent(usuario);
    const empAuto=USER_EMP_MAP[norm(usuario)] || 'TODAS AS EMPRESAS';
    document.getElementById('empresa').value=empAuto;
  }
  run();
});

// ---------- EXECUÇÃO ----------
async function run(){
  const empSel=document.getElementById('empresa').value;
  const periodo=document.getElementById('periodo').value;
  const qs=periodo?`?periodo=${encodeURIComponent(periodo)}`:'';

  const [metasTxt,cancelTxt,satJson]=await Promise.all([
    fetch(URL_METAS+qs).then(r=>r.text()).catch(()=>''), 
    fetch(URL_CANCEL+qs).then(r=>r.text()).catch(()=>''), 
    fetch(URL_SAT+qs).then(r=>r.json()).catch(()=>[])
  ]);
  const metas=parseMetasTexto(metasTxt);
  const cancel=parseCancelTexto(cancelTxt);
  const satAgg=aggregateSatisfacao(satJson);

  const empresas = empSel==='TODAS AS EMPRESAS' ? EMPRESAS : [empSel];
  const container=document.getElementById('content'); container.innerHTML='';

  for(const emp of empresas){
    const empNorm=norm(emp); const travasNome=MAP_TRAVAS[emp]||emp; const travasKey=norm(travasNome);
    let travas=await fetch(URL_TRAVAS+(qs+(qs?'&':'?')+'empresa='+encodeURIComponent(travasNome))).then(r=>r.json()).catch(()=>[]);
    let trav = Array.isArray(travas) ? (travas.find(x=>norm(x.empresa)===travasKey) || travas.find(x=>norm(x.empresa)===empNorm) || travas[0]) : null;

    const m=metas.find(x=>norm(x.empresa)===empNorm) || {meta:0,realizado:0};
    const c=cancel.find(x=>norm(x.empresa)===empNorm) || {itens:[],total:0};

    const {totalGeral9, fornecedores9, forSubs9} = somasPorFonte9(trav||{});
    const travaCompras=trav?Number(trav.travaCompras||0):0;
    const sobra=travaCompras - fornecedores9;
    const consumoPct=travaCompras>0 ? (fornecedores9/travaCompras*100):0;

    const sec=document.createElement('section'); sec.className='company';
    sec.innerHTML=`
      <div class="title">${emp}</div>
      <div class="kpis">
        <div class="kpi"><div class="label">Meta de Compras</div><div class="value">${moeda(m.meta)}</div></div>
        <div class="kpi"><div class="label">Compras Realizadas</div><div class="value">${moeda(m.realizado)}</div><div class="hint">${m.meta>0?(m.realizado/m.meta*100).toFixed(1):'0.0'}% do limite</div></div>
        <div class="kpi"><div class="label">Cancelamentos (R$)</div><div class="value">${moeda(c.total)}</div><div class="hint">${(c.itens||[]).length} itens</div></div>
        <div class="kpi"><div class="label">Trava de Compras</div><div class="value">${trav?moeda(travaCompras):'—'}</div><div class="hint">${trav?consumoPct.toFixed(1)+'% consumidos':'—'}</div></div>
        <div class="kpi"><div class="label">Trava Total (Fonte 9)</div><div class="value">${trav?moeda(totalGeral9):'—'}</div><div class="hint">somente fonte 9</div></div>
        <div class="kpi"><div class="label">Fornecedores (Fonte 9)</div><div class="value">${trav?moeda(fornecedores9):'—'}</div><div class="hint">${trav?(sobra>=0?'Sobra: ':'Estouro: ')+moeda(Math.abs(sobra)):'—'}</div></div>
      </div>
      <div class="grid">
        <div class="card"><div class="title">Metas x Realizado</div><canvas id="${idOf('m')}"></canvas><div class="hint" style="margin-top:8px">${(m.meta>0?(m.realizado/m.meta*100):0)>100?pill('🚨 Estouro','bad'):pill('✅ Dentro do limite','ok')}</div></div>
        <div class="card"><div class="title">Cancelamentos (Top itens)</div><canvas id="${idOf('c')}"></canvas><ul id="${idOf('lc')}"></ul></div>
        <div class="card"><div class="title">Trava de Compras • Top Subcategorias (Fornecedores)</div><canvas id="${idOf('f')}"></canvas><ul id="${idOf('lf')}"></ul></div>
        <div class="card"><div class="title">Satisfação dos Clientes</div><canvas id="${idOf('s')}"></canvas></div>
      </div>`;
    container.appendChild(sec);

    const cvs=sec.querySelectorAll('canvas');
    const [ctxM,ctxC,ctxF,ctxS]=[...cvs].map(x=>x.getContext('2d'));
    new Chart(ctxM,{type:'bar',data:{labels:['Meta','Realizado'],datasets:[{data:[m.meta||0,m.realizado||0]}]},options:{responsive:true,plugins:{legend:{display:false}},scales:{y:{beginAtZero:true}}}});
    const topC=[...(c.itens||[])].sort((a,b)=>b.valor-a.valor).slice(0,10);
    new Chart(ctxC,{type:'bar',data:{labels:topC.map(i=>i.nome),datasets:[{data:topC.map(i=>i.valor)}]},options:{responsive:true,plugins:{legend:{display:false}},scales:{y:{beginAtZero:true}}}});
    const ulC=sec.querySelector('ul[id^="lc-"]'); topC.slice(0,5).forEach(i=>{const li=document.createElement('li');li.textContent=`${i.nome} — ${moeda(i.valor)}`;ulC.appendChild(li);});
    const topF=[...(forSubs9||[])].sort((a,b)=>Math.abs(b.valor)-Math.abs(a.valor)).slice(0,10);
    new Chart(ctxF,{type:'bar',data:{labels:topF.map(s=>s.nome),datasets:[{data:topF.map(s=>Math.abs(s.valor||0))}]},options:{responsive:true,plugins:{legend:{display:false}},scales:{y:{beginAtZero:true}}}});
    const ulF=sec.querySelector('ul[id^="lf-"]'); topF.forEach(s=>{const li=document.createElement('li'); li.textContent=`${s.nome} — ${moeda(s.valor)}`; ulF.appendChild(li);});
    const sat=satAgg[empNorm]||{Excelente:0,Bom:0,Regular:0,Ruim:0};
    new Chart(ctxS,{type:'pie',data:{labels:['Excelente','Bom','Regular','Ruim'],datasets:[{data:[sat.Excelente,sat.Bom,sat.Regular,sat.Ruim],backgroundColor:['#22c55e','#0ea5e9','#f59e0b','#ef4444']}]} ,options:{responsive:true,plugins:{legend:{position:'bottom'}}}});
  }
}
</script>
</body>
</html>
